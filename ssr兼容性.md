> ğŸ’­ å—¯ï¼Œç”¨æˆ·ç°åœ¨é—®çš„æ˜¯SSRï¼ˆæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼‰ä¸­çš„å¡ç‚¹ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­å“ªäº›ä»£ç éœ€è¦åšpolyfillã€‚é¦–å…ˆæˆ‘éœ€è¦ç†è§£ç”¨æˆ·çš„å…·ä½“é—®é¢˜å’ŒèƒŒæ™¯ã€‚å¯èƒ½ä»–ä»¬åœ¨å°è¯•å®ç°SSRæ—¶é‡åˆ°äº†é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å…¼å®¹æ€§æ–¹é¢çš„ï¼Œä¾‹å¦‚æŸäº›ä»£ç åœ¨æœåŠ¡ç«¯æŠ¥é”™ï¼Œè€Œå®¢æˆ·ç«¯æ­£å¸¸ã€‚
>
> ç”¨æˆ·æåˆ°â€œå¡ç‚¹â€ï¼Œå¯èƒ½æŒ‡çš„æ˜¯SSRå®ç°è¿‡ç¨‹ä¸­çš„éš¾ç‚¹æˆ–å¸¸è§é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œè¦åˆ¤æ–­å“ªäº›ä»£ç éœ€è¦polyfillã€‚è¦è€ƒè™‘æœåŠ¡ç«¯ç¯å¢ƒå’Œå®¢æˆ·ç«¯ç¯å¢ƒçš„å·®å¼‚ï¼Œå› ä¸ºNode.jså’Œæµè§ˆå™¨çš„è¿è¡Œç¯å¢ƒä¸åŒï¼ŒæŸäº›APIæˆ–è€…ç‰¹æ€§å¯èƒ½ä¸è¢«æ”¯æŒï¼Œå¯¼è‡´æœåŠ¡å™¨ç«¯è¿è¡Œæ—¶æŠ¥é”™ã€‚
>
> é¦–å…ˆï¼Œæˆ‘éœ€è¦å›é¡¾Node.jsä¸æµè§ˆå™¨ç¯å¢ƒçš„å·®å¼‚ã€‚æ¯”å¦‚ï¼Œæµè§ˆå™¨æœ‰windowã€documentç­‰å…¨å±€å¯¹è±¡ï¼Œè€ŒNode.jsæœ‰processã€Bufferç­‰ã€‚å¦‚æœä»£ç ä¸­ç›´æ¥ä½¿ç”¨äº†è¿™äº›æµè§ˆå™¨ç‰¹æœ‰çš„å¯¹è±¡ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä¼šæŠ¥é”™ï¼Œæ¯”å¦‚è°ƒç”¨document.getElementByIdçš„æ—¶å€™ã€‚è¿™å°±éœ€è¦polyfillæˆ–è€…åœ¨SSRæ—¶é¿å…ä½¿ç”¨è¿™äº›APIã€‚
>
> æ¥ä¸‹æ¥ï¼Œå¦‚ä½•åˆ¤æ–­å“ªäº›ä»£ç éœ€è¦polyfillå‘¢ï¼Ÿä¸€ä¸ªå¯èƒ½çš„æ€è·¯æ˜¯åˆ©ç”¨æ„å»ºå·¥å…·æˆ–æ¨¡å—è¯†åˆ«è¿™äº›ç¯å¢ƒç›¸å…³çš„ä»£ç ã€‚æ¯”å¦‚ï¼Œé€šè¿‡Webpackçš„targeté…ç½®è®¾ç½®ä¸ºnodeï¼Œæ’é™¤æ‰æµè§ˆå™¨çš„ç‰¹å®šæ¨¡å—ã€‚ä½†åœ¨å®é™…ä¸­å¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†ã€‚
>
> å¯èƒ½çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š
>
> 1. æ£€æŸ¥ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å«æœ‰Node.jsä¸æ”¯æŒçš„APIã€‚
>
> ä¾‹å¦‚ï¼ŒæŸäº›åº“å¯èƒ½ä½¿ç”¨äº†fetchã€windowã€localStorageç­‰ï¼Œè€Œè¿™äº›åœ¨Nodeä¸­ä¸å­˜åœ¨ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦polyfillï¼Œæˆ–è€…æ›¿æ¢ä¸ºåŒæ„ï¼ˆisomorphicï¼‰çš„å®ç°ï¼Œæ¯”å¦‚ä½¿ç”¨node-fetchæ¥åœ¨æœåŠ¡ç«¯æ¨¡æ‹Ÿfetchã€‚
>
> 2. ä½¿ç”¨æ„å»ºæ—¶çš„ç¯å¢ƒå˜é‡æˆ–è€…æ¡ä»¶åˆ¤æ–­ï¼ŒåŒºåˆ†SSRå’Œå®¢æˆ·ç«¯ç¯å¢ƒã€‚
>
> ä¾‹å¦‚ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨if (typeof window === 'undefined')æ¥è¯†åˆ«æœåŠ¡ç«¯ç¯å¢ƒï¼Œæ­¤æ—¶é¿å…æ‰§è¡Œæµè§ˆå™¨ç‰¹å®šçš„ä»£ç ã€‚
>
> 3. åˆ©ç”¨Webpackæˆ–Babelçš„é…ç½®æ¥æ’é™¤æŸäº›æ¨¡å—åœ¨æœåŠ¡ç«¯çš„æ‰“åŒ…ã€‚
>
> æ¯”å¦‚ï¼Œé€šè¿‡é…ç½®externalsè®©æŸäº›åªåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨çš„åº“åœ¨æœåŠ¡ç«¯ä¸è¢«æ‰“åŒ…ã€‚
>
> 4. åˆ†æé”™è¯¯æ—¥å¿—ï¼Œæ‰¾åˆ°å…·ä½“çš„æŠ¥é”™ä½ç½®ï¼Œè¿›è€Œåˆ¤æ–­ç¼ºå°‘å“ªäº›polyfillã€‚
>
> ä¾‹å¦‚ï¼Œå½“æœåŠ¡ç«¯æ¸²æŸ“æ—¶æŠ¥é”™ReferenceError: document is not definedï¼Œè¯´æ˜ä»£ç ä¸­ç›´æ¥ä½¿ç”¨äº†documentå¯¹è±¡ï¼Œæ­¤æ—¶éœ€è¦æ£€æŸ¥åœ¨å“ªéƒ¨åˆ†ä»£ç ä¸­å¼•ç”¨äº†DOM APIï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚
>
> æ­¤å¤–ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦äº†è§£å¦‚ä½•ç³»ç»Ÿåœ°è§£å†³è¿™äº›é—®é¢˜ï¼Œè€Œä¸æ˜¯æ¯æ¬¡é‡åˆ°é”™è¯¯æ‰å¤„ç†ã€‚æ¯”å¦‚ï¼Œå»ºç«‹ä¸€å¥—æ£€æµ‹æœºåˆ¶æˆ–è€…å·¥å…·ï¼Œæ¥è¯†åˆ«æ½œåœ¨çš„ä¸å…¼å®¹ä»£ç ã€‚
>
> è¿˜å¯èƒ½éœ€è¦è€ƒè™‘æŸäº›æ–°è¯­æ³•çš„é—®é¢˜ï¼Œå¦‚ES6+çš„è¯­æ³•ã€‚è™½ç„¶Node.jsç°åœ¨æ”¯æŒå¤§éƒ¨åˆ†ES6ç‰¹æ€§ï¼Œä½†å¦‚æœæ˜¯è¾ƒæ—§çš„ç‰ˆæœ¬å¯èƒ½éœ€è¦Babelè½¬æ¢ã€‚
>
> å¦‚ä½•è‡ªåŠ¨åŒ–æ£€æµ‹å“ªäº›éœ€è¦polyfillï¼Ÿè¿™é‡Œå¯èƒ½éœ€è¦ä»£ç åˆ†æå·¥å…·ï¼Œæ¯”å¦‚ä½¿ç”¨ESLintæ’ä»¶æ¥æ£€æµ‹å¯¹æµè§ˆå™¨ç‰¹å®šAPIçš„ä½¿ç”¨ï¼Œæˆ–è€…åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨bundlesizeç­‰å·¥å…·è¿›è¡Œæ£€æµ‹ã€‚
>
> SSRä¸­æ¨¡å—åŠ è½½çš„é—®é¢˜ä¹Ÿæ˜¯éœ€è¦æ³¨æ„çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œç”±äºæ¨¡å—åŠ è½½æ–¹å¼ä¸åŒï¼Œå¯èƒ½éœ€è¦é…ç½®ä¸åŒçš„å…¥å£æ–‡ä»¶æˆ–æ¨¡å—è§£æè§„åˆ™ã€‚
>
> æ­¤å¤–ï¼Œå…³äºpolyfillçš„é€‰æ‹©å’ŒæœåŠ¡ç«¯çš„è´Ÿè½½é—®é¢˜ã€‚æ¯”å¦‚ï¼Œå¯¹äºæŸäº›è¾ƒå¤§çš„polyfillæ˜¯å¦åº”è¯¥åœ¨æœåŠ¡ç«¯å¼•å…¥ï¼Œä¼šä¸ä¼šå½±å“æ€§èƒ½ã€‚è¿™æ—¶å€™å¯èƒ½éœ€è¦ä»…æ·»åŠ å¿…è¦çš„polyfillï¼Œæˆ–è€…å¯»æ‰¾è½»é‡çº§çš„æ›¿ä»£æ–¹æ¡ˆã€‚
>
> æ€»ç»“æ¥è¯´ï¼Œé—®é¢˜æ ¸å¿ƒæ˜¯è¯†åˆ«å¹¶å¤„ç†æœåŠ¡ç«¯ä¸æ”¯æŒæµè§ˆå™¨ç‰¹æœ‰çš„APIã€å…¨å±€å˜é‡å’Œæ¨¡å—ã€‚éœ€è¦é€šè¿‡ç¯å¢ƒæ£€æµ‹ã€æ„å»ºé…ç½®ã€æ¡ä»¶å¼•å…¥ç­‰ç­–ç•¥è§£å†³ï¼ŒåŒæ—¶ç»“åˆå·¥å…·è¿›è¡Œé™æ€åˆ†æå’Œé”™è¯¯è¿½è¸ªã€‚
>
> 



åœ¨å¤„ç† Server-Side Renderingï¼ˆSSRï¼‰çš„ Polyfill é—®é¢˜æ—¶ï¼Œæ ¸å¿ƒæŒ‘æˆ˜åœ¨äº**è¯†åˆ«æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰çš„ç¯å¢ƒå·®å¼‚**ï¼Œå¹¶é’ˆå¯¹ä¸¤è€…ä¹‹é—´çš„ä¸ä¸€è‡´æ€§è¿›è¡Œæœ‰æ•ˆå¤„ç†ã€‚ä»¥ä¸‹ä»åˆ¤æ–­æ ‡å‡†ã€å®šä½æ–¹æ³•å’Œå®è·µæ–¹æ¡ˆä¸‰ä¸ªç»´åº¦å±•å¼€ã€‚

---

### ä¸€ã€SSR Polyfill çš„â€œå¡ç‚¹â€ä¸åˆ¤æ–­é€»è¾‘

#### 1. **ä¸ºä»€ä¹ˆéœ€è¦ Polyfillï¼Ÿ**
- **ç¯å¢ƒå·®å¼‚**ï¼šNode.js ä»…å®ç°éƒ¨åˆ†æµè§ˆå™¨ APIï¼ˆå¦‚ç¼ºå¤± `window`ã€`document`ã€`navigator`ï¼‰ï¼Œä¸åŒç‰ˆæœ¬çš„ Node.js æ”¯æŒçš„ ECMAScript ç‰¹æ€§ä¸åŒï¼ˆå¦‚é™æ€å¯¼å…¥ `import/export`ï¼‰ã€‚
- **ç¬¬ä¸‰æ–¹ä¾èµ–é—®é¢˜**ï¼šå‰ç«¯åº“ï¼ˆå¦‚ `ReactDOM`ï¼‰å¯èƒ½åœ¨ SSR é˜¶æ®µè®¿é—®æµè§ˆå™¨ API å¯¼è‡´é”™è¯¯ï¼ˆå¦‚ `document.createElement`ï¼‰ï¼Œéœ€é€šè¿‡ Polyfill æˆ–ç¯å¢ƒéš”ç¦»å¤„ç†ã€‚
- **åŠ¨æ€ç‰¹æ€§åŠ è½½**ï¼šå®¢æˆ·ç«¯æŒ‰éœ€åŠ è½½çš„è„šæœ¬å¯èƒ½ç ´å SSR çš„åŒæ­¥æ¸²æŸ“æµç¨‹ã€‚

#### 2. **åˆ¤æ–­â€œéœ€è¦ Polyfillâ€çš„åœºæ™¯**
| è§¦å‘åœºæ™¯                  | å…¸å‹é”™è¯¯ç¤ºä¾‹                          | æ’æŸ¥æ€è·¯                               |
|---------------------------|--------------------------------------|----------------------------------------|
| **æµè§ˆå™¨å…¨å±€å˜é‡ç¼ºå¤±**    | `ReferenceError: window is not defined` | æ£€æŸ¥ä»£ç ä¸­å¯¹ `window`ã€`document` çš„ç›´æ¥å¼•ç”¨ |
| **ç‰¹å¼‚æ€§ API è°ƒç”¨**       | `TypeError: fetch is not a function` | æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† `fetch`ã€`History API`         |
| **æ¨¡å—çº§ç¯å¢ƒä¾èµ–**        | `Error: Can't resolve 'fs'`          | å‰ç«¯ä»£ç é”™è¯¯å¼•å…¥ Node.js ä¸“ç”¨æ¨¡å—ï¼ˆå¦‚ `fs`ï¼‰ |
| **ESM/CJS æ··ç”¨é—®é¢˜**       | `SyntaxError: Cannot use import outside a module` | ç¡®ä¿ `.babelrc` é…ç½®æ­£ç¡®æˆ–ä½¿ç”¨ `esm` åŒ…       |

---

### äºŒã€Polyfill å®æ–½ç­–ç•¥

#### 1. **ç¯å¢ƒéš”ç¦»ä¸æ¡ä»¶æ¸²æŸ“**
é€šè¿‡ **æ„å»ºæ—¶é™æ€åŒºåˆ†** æˆ– **è¿è¡Œæ—¶åŠ¨æ€åˆ¤æ–­** éš”ç¦»ä»£ç ï¼š
```javascript
// ğŸ’¡ æ–¹æ¡ˆ 1ï¼šæ„å»ºæ—¶é€šè¿‡ Webpack.DefinePlugin æ³¨å…¥ç¯å¢ƒå˜é‡
if (process.env.SSR) {
  globalThis.window = {}; // Mock ç©ºå¯¹è±¡
}

// ğŸ’¡ æ–¹æ¡ˆ 2ï¼šè¿è¡Œæ—¶åŠ¨æ€æ£€æµ‹ç¯å¢ƒ
if (typeof window === 'undefined') {
  const { serverFetch } = require('./server-fetch-polyfill');
  global.fetch = serverFetch; // æ›¿æ¢ä¸ºæœåŠ¡ç«¯å…¼å®¹å®ç°
}
```

#### 2. **æ¨¡å—æ›¿æ¢ä¸æ ‘æ‘‡ä¼˜åŒ–**
- åˆ©ç”¨ Webpack çš„ `externals` æˆ– `resolve.alias` æ›¿æ¢æ¨¡å—ï¼š
```javascript
// webpack.server.config.js
module.exports = {
  externals: {
    'react-dom/client': 'react-dom/server', // æœåŠ¡ç«¯æ›¿æ¢ä¸º server ç‰ˆæœ¬
  },
};
```
- ä½¿ç”¨ `babel-plugin-transform-imports` **æŒ‰éœ€è½¬æ¢ä»£ç è·¯å¾„**ï¼Œé¿å…éå¿…è¦çš„ Polyfill å¼•ç”¨ã€‚

---

### ä¸‰ã€è‡ªåŠ¨åŒ–æ£€æµ‹ä¸è½åœ°å·¥å…·

#### 1. **é™æ€åˆ†æå·¥å…·**
- **ESLint æ’ä»¶**ï¼šé…ç½®è‡ªå®šä¹‰è§„åˆ™ï¼Œä¾‹å¦‚ `no-restricted-globals` æ£€æµ‹ `window`ï¼š
```javascript
// .eslintrc.js
module.exports = {
  rules: {
    'no-restricted-globals': ['error', 'window', 'document'],
  },
};
```
- **Babel AST è§£æ**ï¼šæ‰«æä»£ç ä¸­ä½¿ç”¨æµè§ˆå™¨æ¥å£çš„èŠ‚ç‚¹ï¼Œè¾“å‡ºæ½œåœ¨é£é™©æŠ¥å‘Šã€‚

#### 2. **åŠ¨æ€è¿è¡Œæ—¶æ£€æµ‹**
é€šè¿‡ **Mock ç¯å¢ƒæ²™ç®±** æå‰æš´éœ²é—®é¢˜ï¼š
```javascript
// åœ¨ Jest æˆ– Mocha ä¸­æ¨¡æ‹ŸæœåŠ¡ç«¯ç¯å¢ƒ
beforeEach(() => {
  global.window = undefined;
  global.document = undefined;
});
test('SSR ç»„ä»¶æ¸²æŸ“ä¸ä¾èµ–æµè§ˆå™¨ API', () => {
  expect(() => renderToString(<App />)).not.toThrow();
});
```

#### 3. **Polyfill æ³¨å…¥å·¥å…·**
- **éšæ„å»ºæ‰“åŒ… (Webpack)**ï¼š
```javascript
// webpack.server.config.js
const nodeExternals = require('webpack-node-externals');

module.exports = {
  target: 'node',
  externals: [nodeExternals({ allowlist: [/^polyfill-/] })], // å…è®¸ç‰¹å®š Polyfill åŒ…å«
  plugins: [
    new webpack.ProvidePlugin({
      fetch: 'node-fetch', // å…¨å±€æ›¿æ¢ fetch
    }),
  ],
};
```
- **æŒ‰éœ€åŠ¨æ€åŠ è½½**ï¼ˆé€‚ç”¨è½»é‡çº§åœºæ™¯ï¼‰ï¼š
```javascript
// server.js
if (typeof fetch === 'undefined') {
  require('whatwg-fetch');
}
```

---

### å››ã€åˆ†å±‚è§£å†³ï¼šPolyfill ä¼˜å…ˆçº§ç­–ç•¥

#### 1. **æœåŠ¡ç«¯ä»£ç å±‚**
- **Node.js ç‰ˆæœ¬å‡çº§**ï¼šå°½å¯èƒ½é€‰æ‹©æ”¯æŒç°ä»£ ECMAScript çš„ Node.js ç‰ˆæœ¬ï¼ˆå¦‚ â‰¥16.xï¼‰ã€‚
- **æ ¸å¿ƒ Polyfill é¢„ç½®**ï¼š
  ```bash
  npm install --save core-js @babel/runtime-corejs3
  ```

#### 2. **åº”ç”¨æ¡†æ¶å±‚**
- **Next.js ç­‰æ¡†æ¶å†…ç½®æ–¹æ¡ˆ**ï¼š  
  Next.js é»˜è®¤å¤„ç† `window` å’Œ `document` å·®å¼‚ï¼Œä»…åœ¨ `getServerSideProps` ä¸­ç¦ç”¨æµè§ˆå™¨ APIã€‚
- **Webpack æ„å»ºä¼˜åŒ–**ï¼šåˆ©ç”¨ `target: 'node'` è‡ªåŠ¨æ’é™¤æµè§ˆå™¨ APIã€‚

#### 3. **ç¬¬ä¸‰æ–¹ä¾èµ–å±‚**
- **æ›¿æ¢ä¸ºåŒæ„åº“**ï¼šæµè§ˆå™¨ä¸“ç”¨åº“æ”¹ç”¨å…¼å®¹æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼š
  - `whatwg-fetch` â†’ `node-fetch`
  - `localStorage` â†’ æœåŠ¡ç«¯ `memoryStorage` æ¨¡æ‹Ÿ
- **åŠ¨æ€åŠ è½½ Renderer**ï¼šä»…åœ¨å®¢æˆ·ç«¯æ¿€æ´»äº¤äº’å¼ç»„ä»¶ï¼š
```javascript
// åŠ¨æ€å¯¼å…¥é¿å…æœåŠ¡ç«¯åŠ è½½
const SafeHydration = dynamic(() => import('../components/ClientOnly'), {
  ssr: false,
});
```

---

### äº”ã€æ¡ˆä¾‹ï¼šReact SSR çš„ Polyfill å¤„ç†

#### åœºæ™¯ï¼šCSR/SSR æ··åˆåº”ç”¨ä¸­æ¸²æŸ“å¤±è´¥
```javascript
// âŒ é”™è¯¯ä»£ç 
function App() {
  const [data, setData] = useState(null);
  useEffect(() => {
    fetch('/api/data').then(res => setData(res)); // åœ¨ SSR é˜¶æ®µè§¦å‘æŠ¥é”™
  }, []);

  return <div>{data}</div>;
}

// âœ… ä¿®å¤æ–¹æ¡ˆ
function App({ initialData }) { // ä»SSRæ³¨å…¥åˆå§‹æ•°æ®
  const [data, setData] = useState(initialData); // æ— éœ€å®¢æˆ·ç«¯å†è¯·æ±‚
  return <div>{data}</div>;
}

// SSR æœåŠ¡ç«¯ä»£ç 
export async function getServerSideProps() {
  const res = await serverFetch('/api/data'); // æœåŠ¡ç«¯ä¸“ç”¨ fetch
  return { props: { initialData: res.data } };
}
```

---

### å…­ã€æ€»ç»“

**SSR Polyfill çš„æ ¸å¿ƒæ€è·¯**ï¼š
1. **ç¯å¢ƒéš”ç¦»**ï¼šä¸¥æ ¼åŒºåˆ†æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚
2. **é™æ€åˆ†æ**ï¼šå€ŸåŠ©å·¥å…·æ£€æµ‹ä¸å…¼å®¹çš„ä»£ç è·¯å¾„ã€‚
3. **ç²¾å‡† Polyfill**ï¼šæŒ‰éœ€æ³¨å…¥ï¼Œé¿å…å…¨é‡æ‰“åŒ…å½±å“æ€§èƒ½ã€‚
4. **åŒæ„è®¾è®¡**ï¼šä¼˜å…ˆé€‰æ‹©è·¨ç«¯å…¼å®¹çš„åº“æˆ–ç¼–å†™é€‚é…å±‚ã€‚
