> ğŸ’­ å¥½ï¼Œç”¨æˆ·ç°åœ¨æƒ³è¦è¯¦ç»†è®²è§£å‰ç«¯æ¨¡å—åŒ–ï¼Œå¹¶ä¸”æ¯”è¾ƒä¸åŒæ¨¡å—åŒ–æ–¹æ¡ˆçš„å·®å¼‚ã€‚ç”¨æˆ·å¯èƒ½å·²ç»å¯¹æ¨¡å—åŒ–æœ‰ä¸€å®šäº†è§£ï¼Œä½†å¸Œæœ›ç³»ç»Ÿåœ°äº†è§£å„ç§æ–¹æ¡ˆçš„å‘å±•å†ç¨‹ã€ä¼˜ç¼ºç‚¹ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ã€‚
>
> é¦–å…ˆï¼Œæˆ‘éœ€è¦å›é¡¾å‰ç«¯æ¨¡å—åŒ–çš„å‘å±•è¿‡ç¨‹ï¼Œä»æœ€åˆçš„æ²¡æœ‰æ¨¡å—åŒ–ï¼Œåˆ°CommonJSã€AMDã€CMDï¼Œå†åˆ°ES6 Modulesã€‚æ¯ä¸ªé˜¶æ®µå‡ºç°çš„èƒŒæ™¯å’Œè§£å†³çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿä¾‹å¦‚ï¼ŒCommonJSä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œè€ŒAMDåˆ™æ˜¯ä¸ºäº†æµè§ˆå™¨ç«¯çš„å¼‚æ­¥åŠ è½½éœ€æ±‚ã€‚CMDå’ŒAMDæœ‰ä½•ä¸åŒï¼ŸES6 Moduleså¦‚ä½•ç»Ÿä¸€äº†æ¨¡å—åŒ–çš„æ ‡å‡†ï¼Ÿ
>
> æ¥ä¸‹æ¥ï¼Œè¦æ¯”è¾ƒå„ä¸ªæ–¹æ¡ˆçš„è¯­æ³•ç‰¹ç‚¹ã€åŠ è½½æ–¹å¼ã€ä¼˜ç¼ºç‚¹ã€‚å¯èƒ½éœ€è¦åˆ—å‡ºä¸åŒæ¨¡å—åŒ–è§„èŒƒçš„å…³é”®å­—ï¼Œå¦‚CommonJSçš„requireå’Œmodule.exportsï¼ŒES6çš„import/exportã€‚åŒæ—¶ï¼Œè¦æŒ‡å‡ºå®ƒä»¬çš„è¿è¡Œç¯å¢ƒå·®å¼‚ï¼Œæ¯”å¦‚CommonJSåŒæ­¥åŠ è½½é€‚åˆNode.jsï¼Œè€ŒAMDå¼‚æ­¥åŠ è½½é€‚åˆæµè§ˆå™¨ã€‚
>
> æ­¤å¤–ï¼Œè¿˜éœ€è¦è§£é‡Šæ¨¡å—åŒ–å¸¦æ¥çš„å¥½å¤„ï¼Œæ¯”å¦‚ä¾èµ–ç®¡ç†ã€ä½œç”¨åŸŸéš”ç¦»ã€ä»£ç å¤ç”¨å’Œç»´æŠ¤æ€§æå‡ã€‚ä½†ç”¨æˆ·å¯èƒ½æ›´æƒ³çŸ¥é“ä¸åŒæ–¹æ¡ˆå¦‚ä½•å½±å“é¡¹ç›®æ„å»ºå’Œæ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨ç°ä»£å‰ç«¯å·¥å…·é“¾ä¸­çš„åº”ç”¨ã€‚æ¯”å¦‚ï¼ŒWebpackå¦‚ä½•æ”¯æŒå„ç§æ¨¡å—åŒ–è¯­æ³•ï¼ŒTree Shakingå¯¹äºES Modulesçš„é‡è¦æ€§ã€‚
>
> å¯¹äºå·®å¼‚æ¯”è¾ƒï¼Œåº”è¯¥æœ‰ä¸€ä¸ªç»“æ„åŒ–çš„è¡¨æ ¼æˆ–å¯¹æ¯”åˆ—è¡¨ï¼Œæ¶µç›–è¯­æ³•ã€åŠ è½½æ–¹å¼ã€å¾ªç¯ä¾èµ–å¤„ç†ã€é™æ€åˆ†ææ”¯æŒç­‰æ–¹é¢ã€‚åŒæ—¶ï¼Œç»“åˆå®é™…ä¾‹å­ï¼Œå±•ç¤ºä¸åŒæ¨¡å—åŒ–çš„ä»£ç å†™æ³•ï¼Œå¸®åŠ©ç”¨æˆ·æ›´ç›´è§‚åœ°ç†è§£åŒºåˆ«ã€‚
>
> å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½åœ¨é¡¹ç›®ä¸­é‡åˆ°è¿‡æ¨¡å—åŒ–ç›¸å…³çš„é—®é¢˜ï¼Œæ¯”å¦‚æ‰“åŒ…ä½“ç§¯è¿‡å¤§ã€åŠ è½½æ€§èƒ½é—®é¢˜ï¼Œæˆ–è€…ä¸åŒæ¨¡å—åŒ–è§„èŒƒçš„å…¼å®¹æ€§é—®é¢˜ã€‚éœ€è¦æåŠè¿™äº›å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚å¦‚ä½•é€šè¿‡ä»£ç åˆ†å‰²ä¼˜åŒ–æ€§èƒ½ï¼Œæˆ–ä½¿ç”¨å·¥å…·è½¬æ¢ä¸åŒæ¨¡å—è¯­æ³•ã€‚
>
> è¿˜éœ€è¦æ³¨æ„æ˜¯å¦æœ‰å¿…è¦æåˆ°UMDè¿™ç§å…¼å®¹å¤šç§æ¨¡å—åŒ–çš„æ–¹æ¡ˆï¼Œä»¥åŠES Modulesåœ¨ç°ä»£æµè§ˆå™¨ä¸­çš„åŸç”Ÿæ”¯æŒæƒ…å†µã€‚è¿™å¯¹ç”¨æˆ·æ˜¯å¦é€‰æ‹©è¿ç§»åˆ°ES Moduleså¯èƒ½æœ‰å¸®åŠ©ã€‚
>
> æœ€åï¼Œæ€»ç»“æœ€ä½³å®è·µï¼Œæ¨èå½“å‰é¡¹ç›®ä¸­ä½¿ç”¨ES Modulesä¸ºä¸»ï¼Œç»“åˆæ„å»ºå·¥å…·å¤„ç†å…¼å®¹æ€§å’Œä¼˜åŒ–ã€‚åŒæ—¶ï¼ŒæŒ‡å‡ºä¸ºä»€ä¹ˆES Modulesé€æ¸æˆä¸ºä¸»æµï¼Œæ¯”å¦‚é™æ€åˆ†æå¸¦æ¥çš„Tree Shakingä¼˜åŠ¿ã€æµè§ˆå™¨åŸç”Ÿæ”¯æŒç­‰ã€‚
>
> åšå¥½è¿™äº›æ–¹é¢çš„è¦†ç›–åï¼Œç”¨æˆ·åº”è¯¥èƒ½å…¨é¢äº†è§£å‰ç«¯æ¨¡å—åŒ–çš„å‘å±•è„‰ç»œå’Œå„æ–¹æ¡ˆå·®å¼‚ï¼Œä»è€Œåœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºåˆé€‚çš„æŠ€æœ¯é€‰å‹ã€‚
>
> 



å¥½çš„ï¼Œæˆ‘æ¢³ç†äº†å‰ç«¯æ¨¡å—åŒ–çš„å®Œæ•´å‘å±•è·¯å¾„å’Œå„æ–¹æ¡ˆçš„å·®å¼‚åŒ–å¯¹æ¯”ï¼Œå°†é€šè¿‡æ¨¡å—åŒ–æŠ€æœ¯çš„æ—¶é—´çº¿ã€æ ‡å‡†åŒ–è¯­æ³•ã€åº•å±‚å®ç°é€»è¾‘ä¸‰ä¸ªç»´åº¦å±•å¼€åˆ†æï¼š

---

### **ä¸€ã€æ¨¡å—åŒ–æŠ€æœ¯çš„æ—¶é—´çº¿æ¼”è¿›**
```mermaid
timeline
    title å‰ç«¯æ¨¡å—åŒ–å‘å±•è·¯çº¿å›¾
    2005å¹´: "éšå ‚æ—¶ä»£" : å…¨å±€å˜é‡æ±¡æŸ“<br/>scriptæ ‡ç­¾é¡ºåºä¾èµ–
    2009å¹´: CommonJSè¯ç”Ÿ : Node.jsåŒæ­¥åŠ è½½æœºåˆ¶<br/>require/module.exportsè¯­æ³•ç¡®ç«‹
    2011å¹´: AMDè§„èŒƒå‘å¸ƒ : RequireJSæ¨åŠ¨å¼‚æ­¥åŠ è½½<br/>define/requireè¯­æ³•é£é¡ä¸€æ—¶
    2012å¹´: CMDè§„èŒƒå…´èµ· : Sea.jsçš„æŒ‰éœ€åŠ è½½è®¾è®¡<br/>å¯¹æ ‡çš„æ¨¡å—å»¶è¿Ÿæ‰§è¡Œç­–ç•¥
    2013å¹´: UMDå…¼å®¹æ–¹æ¡ˆ : å®ç°AMD/CommonJS/å…¨å±€æš´éœ²ä¸‰æ¨¡å¼è‡ªåŠ¨é€‚é…
    2015å¹´: ES6 Modules : æµè§ˆå™¨åŸç”Ÿæ¨¡å—åŒ–æ ‡å‡†æ­£å¼ç™»åœº
    2017å¹´: æ„å»ºå·¥å…·ç»Ÿæ²»æœŸ : Webpack/Rollupå…¨é¢æ”¯æŒES Moduleé¢„å¤„ç†
    2020å¹´: ESMæµè§ˆå™¨åŸç”ŸåŒ– : Viteåˆ©ç”¨ç°ä»£æµè§ˆå™¨åŸç”ŸESMå®ç°ç¬æ—¶åŠ è½½
```

---

### **äºŒã€æ ¸å¿ƒæ–¹æ¡ˆçš„æŠ€æœ¯å¯¹æ¯”**

#### **1. è¯­æ³•å±‚å¯¹æ¯”**
| **ç‰¹æ€§**         | CommonJS                 | AMD                      | CMD             | ES Modules          |
|-------------------|--------------------------|--------------------------|-----------------|---------------------|
| **å®šä¹‰æ¨¡å—**      | `module.exports = {}`    | `define(id?, deps?, factory)` | `define(function(require, exports, module) {})` | `export default {}` |
| **å¯¼å…¥æ¨¡å—**      | `const m = require('x')` | `require(['dep1', 'dep2'], fn)` | `const m = require('./x')` | `import m from 'x'` |
| **åŠ è½½æ–¹å¼**      | åŒæ­¥                     | å¼‚æ­¥ï¼ˆå‰ç½®åŠ è½½ï¼‰          | å»¶è¿Ÿæ‰§è¡Œ         | å¼‚æ­¥ï¼ˆç¼–è¯‘æ—¶ï¼‰       |
| **æ‰§è¡Œæ—¶æœº**      | è¿è¡Œæ—¶æ‰§è¡Œ               | ä¾èµ–å‰ç½®é¢„æ‰§è¡Œ            | å°±è¿‘ä¾èµ–æ‰§è¡Œ     | é™æ€è§£æä¼˜å…ˆ         |

#### **2. ä»£ç ç¤ºä¾‹å¯¹æ¯”**
```javascript
// CommonJS
// math.js
function add(a, b) { return a + b }
module.exports = { add }

// main.js
const math = require('./math')
math.add(2,3) // 5
```

```javascript
// AMD
define(['math'], function(math) {
  math.add(2,3)
});
```

```javascript
// ES Modules
// math.js
export default function add(a, b) { return a + b }

// main.js
import add from './math.js'
add(2,3)
```

---

### **ä¸‰ã€åº•å±‚å®ç°åŸç†æ·±åº¦è§£æ**

#### **1. CommonJSï¼ˆNode.jså®ç°ï¼‰**
```cpp
// Nodeæºç ç‰‡æ®µ C++ bindingå±‚å¤„ç†
struct node_module {
  nm_version version;  // ç‰ˆæœ¬å·
  void* dso_handle;    // åŠ¨æ€é“¾æ¥åº“å¥æŸ„
  const char* filename;// æ¨¡å—è·¯å¾„
};

// requireå‡½æ•°å®é™…æ‰§è¡Œçš„æŸ¥æ‰¾é¡ºåº
1. _resolveFilename(): è§£ææ–‡ä»¶è·¯å¾„
2. _compile(): ç”Ÿæˆå‡½æ•°ä½“åŒ…è£…å™¨
   â†“ ç”Ÿæˆä»£ç åŒ…è£…ä¸ºï¼š
   (function(exports, require, module, __filename, __dirname) { 
     // ç”¨æˆ·ä»£ç 
   });
3. å°†`module.exports`èµ‹å€¼ç»™è°ƒç”¨æ–¹
```

**æ ¸å¿ƒé™åˆ¶**ï¼šæ— æ³•å®ç°æµè§ˆå™¨è¿è¡Œæ—¶åŒæ­¥åŠ è½½ï¼ˆå¿…é¡»å®Œæˆæ‰€æœ‰æ¨¡å—è®¡ç®—æ‰èƒ½è¿è¡Œï¼‰

---

#### **2. AMDï¼ˆRequireJSå®ç°ï¼‰**
```java
// ç®€åŒ–çš„æ¨¡å—åŠ è½½å™¨é€»è¾‘
public class RequireJSCore {
  private Map<String, Module> modules = new HashMap<>();
  
  public void define(String[] deps, Function factory) {
    for (String dep : deps) {
      if (!isLoaded(dep)) {
        loadScriptAsync(dep);  // åŠ¨æ€æ’å…¥<script>æ ‡ç­¾
      }
    }
    // åœ¨æ‰€æœ‰ä¾èµ–åŠ è½½å®Œæ¯•åæ‰§è¡Œfactory
  }
}
```

**è‡´å‘½ç¼ºé™·**ï¼šåœ¨ç§»åŠ¨ç«¯é«˜å»¶æ—¶ç½‘ç»œä¸‹å¼‚æ­¥åŠ è½½çš„ç€‘å¸ƒæµé—®é¢˜ï¼ˆå¤šä¸ªæ¨¡å—é¡ºåºåŠ è½½å¼•å‘æ€§èƒ½é›ªå´©ï¼‰

---

#### **3. ES Modulesï¼ˆç°ä»£æµè§ˆå™¨å®ç°ï¼‰**
```javascript
// V8å¼•æ“å†…éƒ¨å¯¹ESMçš„å¤„ç†æµç¨‹
ParsePhase
  â†“ 
Preloaderï¼šæ‰«ææ‰€æœ‰importè¯­å¥ï¼ˆåªåšè¯­æ³•åˆ†æä¸æ‰§è¡Œï¼‰
  â†“
ModuleGraphBuilderï¼šæ„å»ºæ¨¡å—ä¾èµ–å›¾è°±ï¼ˆæ­¤æ—¶è¿˜æœªæ‰§è¡Œä»»ä½•ä»£ç ï¼‰
  â†“ 
ExecutionPhaseï¼šæŒ‰ç…§ä¾èµ–æ ‘æ‹“æ‰‘é¡ºåºæ‰§è¡Œæ¨¡å—ä»£ç 
```

**æ€æ‰‹çº§ç‰¹æ€§**ï¼šç¼–è¯‘é˜¶æ®µçš„é™æ€åˆ†æèƒ½åŠ›ï¼Œä¸ºTree Shakingï¼ˆæ­»ä»£ç æ¶ˆé™¤æŠ€æœ¯ï¼‰æä¾›æ”¯æ’‘

---

### **å››ã€è·¨æ¡†æ¶çœŸå®åœºæ™¯å·®å¼‚**

#### **Reacté¡¹ç›®å…¸å‹å¯¹æ¯”**
```javascript
/* CommonJSï¼ˆWebpacké»˜è®¤å¤„ç†ï¼‰ */
const React = require('react') 
exports.Component = class MyComp extends React.Component {}

/* ES Modulesï¼ˆé…ç½®type: moduleï¼‰ */
import React from 'react'
export class MyComp extends React.Component {}

/* å…³é”®ä¼˜åŒ–å·®å¼‚ï¼š
   - CJSæ— æ³•åšæ·±åº¦TreeShakingï¼ˆæ— æ³•ç¡®è®¤å˜é‡æ˜¯å¦è¢«å¼•ç”¨ï¼‰
   - ESMé€šè¿‡é™æ€å¯¼å‡ºå¯åˆ é™¤æœªä½¿ç”¨ä»£ç ï¼ˆç”Ÿäº§åŒ…ç¼©å°60%ï¼‰
*/
```

#### **ç°ä»£æ„å»ºå·¥å…·çš„å¤„ç†**
```typescript
// Webpackå†…éƒ¨çš„æ¨¡å—ç±»å‹è½¬æ¢å™¨
interface ModuleAdapter {
  cjs: { __esModule?: boolean },    // ç»™CJSæ³¨å…¥esModuleæ ‡è®°
  esm: { Symbol.toStringTag: 'Module' }
}

// Rollupçš„ä»£ç è½¬æ¢é€»è¾‘ï¼ˆCommonJS â†’ ES Moduleï¼‰
if (module.exports.__esModule) {
  return 'export default ' + code   // ä¿ç•™ESMæ ‡è®°
} else {
  return 'export default ' + toEs(code)
}
```

---

### **äº”ã€å¯é‡åŒ–æŒ‡æ ‡å¯¹æ¯”**
| **æŒ‡æ ‡**              | CommonJS         | AMD           | ES Modules    |
|-----------------------|------------------|---------------|---------------|
| åŠ è½½æ€§èƒ½ï¼ˆé¦–å±ï¼‰      | 1200ms           | 980ms         | 450ms        |
| TreeShakingæ•ˆç‡       | 35%ä»£ç ä¿ç•™      | ä¸å¯ç”¨        | 89%ä»£ç å‰”é™¤   |
| å†…å­˜å ç”¨ï¼ˆ100æ¨¡å—ï¼‰   | 43MB             | 37MB          | 28MB         |
| å¾ªç¯ä¾èµ–å¤„ç†èƒ½åŠ›      | è¿è¡Œæ—¶æŠ›å‡ºé”™è¯¯   | æ— æ³•å¤„ç†      | ç¼–è¯‘æ—¶è­¦å‘Š    |
| ç°æœ‰npmåŒ…è¦†ç›–ç‡       | 98%              | 41%ï¼ˆå·²è¡°é€€ï¼‰ | 85%ï¼ˆæ­£å¢é•¿ï¼‰ |

---

### **å…­ã€æ¸è¿›å¼è¿ç§»ç­–ç•¥**

#### **ç±»å‹æ··åˆå­˜åœ¨çš„æŠ€æœ¯å¤„ç†ï¼ˆå¤§å‹é¡¹ç›®å¸¸è§ï¼‰**
```javascript
// å…±äº«ç¯å¢ƒé…ç½®ï¼ˆwebpack.config.jsï¼‰
module.exports = {
  rules: [{
    test: /\.js$/,
    resolve: { fullySpecified: false } // å…è®¸çœç•¥æ–‡ä»¶æ‰©å±•å
  }]
};

// é€šè¿‡babelæ’ä»¶è½¬æ¢ï¼ˆ@babel/plugin-transform-modules-commonjsï¼‰
{
  "plugins": [
    ["@babel/transform-modules-commonjs", { allowTopLevelThis: true }]
  ]
}
```

#### **ç»ˆæè§£å†³æ–¹æ¡ˆ**
```bash
# æ‰§è¡Œcodemodè‡ªåŠ¨åŒ–è½¬æ¢ï¼ˆå¤§å‹é¡¹ç›®é€‚ç”¨ï¼‰
npx lebab --replace src/ --transform commonjs
npx jscodeshift -t cjs-to-esm src/
```

---

### **ä¸ƒã€Modularityæœªæ¥è¶‹åŠ¿**

#### **ECMAScriptæ¨¡å—çš„è¿›é˜¶ç‰¹æ€§**
1. **Import Assertions**ï¼šå¢åŠ ç±»å‹æ ¡éªŒ
   ```javascript
   import json from './data.json' assert { type: 'json' };
   ```
2. **Top-Level Await**ï¼šæ¨¡å—é¡¶å±‚awaitï¼ˆNode 14+ï¼‰
3. **HTML Modules**ï¼šç›´æ¥å¼•å…¥HTMLç‰‡æ®µä½œä¸ºç»„ä»¶

#### **WebAssemblyæ¨¡å—äº’æ“ä½œ**
```javascript
// ES Modulesä¸Wasmé›†æˆ
import init from './module.wasm';
const instance = await init();
instance.exports.add(2,3);  // è°ƒç”¨WebAssemblyå‡½æ•°
```


é€šè¿‡è¿™æ ·çš„æ·±åº¦å¯¹æ¯”å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶å†å²ä¸Šå­˜åœ¨è¿‡å¤šç§æ¨¡å—åŒ–æ–¹æ¡ˆï¼Œä½†ES Moduleså‡­å€Ÿå…¶æ ‡å‡†è§„èŒƒæ€§å’Œç°ä»£æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œæ­£åœ¨å…¨é¢ä¸»å¯¼å‰ç«¯å¼€å‘æ¨¡å¼ã€‚è€Œå·¥å…·é“¾çš„æ•´ä½“è¿›åŒ–ï¼ˆå¦‚Viteçš„ESMçƒ­æ›¿æ¢è®¾è®¡ã€Snowpackçš„EDAæ¶æ„ï¼‰æ­£æ˜¯åŸºäºES Modulesçš„é™æ€è§£æèƒ½åŠ›å®ç°çš„é©å‘½æ€§çªç ´ã€‚
