> ğŸ’­ ä½œä¸ºä¸€åå‰ç«¯å·¥ç¨‹å¸ˆï¼Œæˆ‘éœ€è¦æ·±å…¥æ¯”è¾ƒCommonJSå’ŒES Moduleï¼ˆESMï¼‰ï¼Œç¡®ä¿å›ç­”æ—¢ä¸“ä¸šåˆè¯¦ç»†ï¼Œæ¶µç›–åŸç†ã€å®é™…å¼€å‘é—®é¢˜å’Œæºç å±‚é¢ã€‚ä¸‹é¢æ˜¯æˆ‘çš„é€æ­¥æ€è€ƒè¿‡ç¨‹ï¼š
>
> é¦–å…ˆï¼Œæˆ‘ä¼šå›é¡¾ä¸¤è€…çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨åœºæ™¯ï¼Œç¡®ä¿å¯¹å®ƒä»¬çš„å®šä¹‰æœ‰æ¸…æ™°çš„ç†è§£ã€‚CommonJSä¸»è¦ç”¨äºNode.jsç¯å¢ƒï¼Œè€ŒESMæ˜¯ECMAScriptçš„æ ‡å‡†æ¨¡å—ç³»ç»Ÿï¼Œé€‚ç”¨äºç°ä»£æµè§ˆå™¨å’ŒNode.jsï¼ˆéœ€é…ç½®ï¼‰ã€‚
>
> æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ¯”è¾ƒå®ƒä»¬çš„åŠ è½½æœºåˆ¶ã€‚CommonJSæ˜¯åŒæ­¥åŠ è½½ï¼Œé€‚ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œè€ŒESMæ˜¯å¼‚æ­¥åŠ è½½ï¼Œé€‚åˆæµè§ˆå™¨ç¯å¢ƒã€‚ç†è§£è¿™ä¸€ç‚¹æœ‰åŠ©äºè§£é‡Šå®ƒä»¬åœ¨æ€§èƒ½å’Œè¡Œä¸ºä¸Šçš„å·®å¼‚ã€‚
>
> ç„¶åæ˜¯è¯­æ³•å·®å¼‚ã€‚CommonJSä½¿ç”¨requireå’Œmodule.exportsï¼Œè€ŒESMä½¿ç”¨importå’Œexportã€‚éœ€è¦æ³¨æ„ESMçš„é™æ€è¯­æ³•ç»“æ„ä¸CommonJSçš„åŠ¨æ€ç‰¹æ€§ä¹‹é—´çš„åŒºåˆ«ã€‚
>
> æ¨¡å—è§£æå’Œè¾“å‡ºæ–¹é¢ï¼ŒCommonJSè¾“å‡ºçš„æ˜¯å€¼çš„æ‹·è´ï¼Œè€ŒESMè¾“å‡ºçš„æ˜¯å€¼çš„å¼•ç”¨ã€‚è¿™ä¸ªåŒºåˆ«å¯¹äºå¾ªç¯ä¾èµ–çš„å¤„ç†å°¤ä¸ºé‡è¦ï¼Œéœ€è¦è¯¦ç»†é˜è¿°ä¸¤è€…çš„ä¸åŒè¡Œä¸ºã€‚
>
> å®é™…å¼€å‘ä¸­çš„é—®é¢˜ä¹Ÿè¦è€ƒè™‘ï¼Œæ¯”å¦‚åœ¨Node.jsä¸­æ··åˆä½¿ç”¨CommonJSå’ŒESMæ—¶å¯èƒ½é‡åˆ°çš„å…¼å®¹æ€§é—®é¢˜ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡æ‰“åŒ…å·¥å…·ï¼ˆå¦‚Webpackã€Rollupï¼‰å¤„ç†æ¨¡å—è½¬æ¢ã€‚
>
> åœ¨åŸç†å’Œæºç å±‚é¢ï¼Œæˆ‘éœ€è¦è§£é‡ŠNode.jsä¸­CommonJSçš„å®ç°æœºåˆ¶ï¼Œå¦‚æ¨¡å—çš„åŒ…è£…ã€ç¼“å­˜ç­‰ã€‚å¯¹äºESMï¼Œå…³é”®ç‚¹åœ¨äºé™æ€åˆ†æå’Œå¼‚æ­¥åŠ è½½ï¼Œè¿˜æœ‰ä¸¤è€…çš„æ¨¡å—è§£æé˜¶æ®µå·®å¼‚ã€‚
>
> æœ€åï¼Œç»“åˆå®é™…æ¡ˆä¾‹ï¼Œè¯´æ˜åœ¨ä¸åŒåœºæ™¯ä¸‹å¦‚ä½•é€‰æ‹©åˆé€‚çš„æ¨¡å—ç³»ç»Ÿï¼Œä»¥åŠç°ä»£å·¥å…·é“¾å¯¹ä¸¤è€…çš„æ”¯æŒæƒ…å†µã€‚éœ€è¦æåˆ°ESMçš„Tree-shakingä¼˜åŠ¿ï¼Œä»¥åŠCommonJSåœ¨åŠ¨æ€åŠ è½½æ—¶çš„çµæ´»æ€§ã€‚
>
> æ•´ä¸ªè¿‡ç¨‹éœ€è¦æœ‰æ¡ç†ï¼Œæ¯ä¸ªå¯¹æ¯”ç‚¹éƒ½è¦æ˜ç¡®ä¸¤è€…çš„åŒºåˆ«ï¼Œå¹¶ç»“åˆå®é™…å¼€å‘ä¸­çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿å›ç­”å…¨é¢ä¸”æ·±å…¥ã€‚
>
> 



### æ·±å…¥æ¯”è¾ƒCommonJSä¸ESModuleï¼ˆé™„æºç çº§å®ç°åŸç†ï¼‰

#### 1. **æ¨¡å—åŠ è½½æœ¬è´¨å·®å¼‚**
**CommonJS**ï¼š
```javascript
// Node.jså†…æ ¸çš„æ¨¡å—åŠ è½½ä¼ªä»£ç 
function require(id) {
  const cachedModule = Module._cache[id];
  if (cachedModule) return cachedModule.exports; // æ ¸å¿ƒç¼“å­˜æœºåˆ¶
  
  const module = { exports: {} }; 
  Module._cache[id] = module; // å­˜å…¥ç¼“å­˜
  
  // ä½¿ç”¨vm.runInThisContextåŒ…è£¹æ‰§è¡Œï¼ˆæ¨¡å—éš”ç¦»ï¼‰
  const wrapperFn = `(function(exports, require, module, __filename, __dirname) {
    ${fs.readFileSync(id)}
  })`;
  const compiledWrapper = vm.runInThisContext(wrapperFn);
  
  compiledWrapper.call(
    module.exports, 
    module.exports, 
    require, 
    module, 
    filename, 
    dirname
  ); // æ³¨å…¥å‚æ•°
  
  return module.exports; // è¿”å›å€¼æ‹·è´
}
```
**å…³é”®ç‰¹æ€§**ï¼šè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ã€åŒæ­¥IOã€å¯¼å‡ºå€¼æ‹·è´ã€å¯ä»¥æ¡ä»¶å¼åŠ è½½

**ESModule**ï¼š
```javascript
// æµè§ˆå™¨ç«¯ESMåŠ è½½æµç¨‹
1. è§£æé˜¶æ®µï¼šä¸‹è½½æ‰€æœ‰æ¨¡å—å¹¶æ„å»ºæ¨¡å—è®°å½•ï¼ˆModule Recordï¼‰
2. å®ä¾‹åŒ–é˜¶æ®µï¼šå»ºç«‹å†…å­˜ç©ºé—´å¹¶å®æ—¶ç»‘å®šï¼ˆLive Bindingï¼‰
3. æ‰§è¡Œé˜¶æ®µï¼šè¿è¡Œé¡¶å±‚ä»£ç å¡«å……ç»‘å®šå€¼

// Node.jså†…éƒ¨å®ç°ï¼ˆlib/internal/modules/esm/ï¼‰
async function load(url, context) {
  if (status === 'uninitialized') {
    await initializeImportMeta(this); // å…ƒæ•°æ®åˆå§‹åŒ–
    await parseModule(this); // é™æ€åˆ†æä¾èµ–
    await linkModule(this); // å»ºç«‹å®æ—¶ç»‘å®š
  }
  return this.getExports(); // è¿”å›å¼•ç”¨åœ°å€
}
```
**å…³é”®ç‰¹æ€§**ï¼šç¼–è¯‘æ—¶é™æ€åˆ†æã€å¼‚æ­¥åŠ è½½ã€å®æ—¶ç»‘å®šã€é¡¶å±‚åªè¯»

---

#### 2. **è¾“å‡ºç»“æœä¸å†…å­˜è¡¨ç°**
**CommonJSå¯¼å‡ºæ‹·è´**ï¼š
```javascript
// count.js
let count = 0;
function increment() { count++ }
module.exports = { count, increment };

// main.js 
const { count, increment } = require('./count');
console.log(count); // 0 
increment();
console.log(count); // 0ï¼ˆå¯¼å‡ºæ—¶ä¸ºå€¼æ‹·è´ï¼‰
```

**ESMå®æ—¶ç»‘å®š**ï¼š
```javascript
// count.mjs 
export let count = 0;
export function increment() { count++ }

// main.mjs 
import { count, increment } from './count.mjs';
console.log(count); // 0
increment();
console.log(count); // 1ï¼ˆå®æ—¶ç»‘å®šå¼•ç”¨ï¼‰
```

---

#### 3. **æ€§èƒ½å¯¹æ¯”æµ‹é‡**
**ç¼“å­˜ç³»ç»Ÿå‹åŠ›æµ‹è¯•**ï¼š
```javascript
// 10ä¸‡æ¬¡é‡å¤åŠ è½½åŒä¸€æ¨¡å—
console.time('CJS');
for (let i = 0; i < 1e5; i++) {
  require('./heavy-module'); // è§¦å‘_.cacheæŸ¥æ‰¾
}
console.timeEnd('CJS'); // å¹³å‡è€—æ—¶çº¦42msï¼ˆNode 16.xï¼‰

console.time('ESM');
const load = async () => {
  for (let i = 0; i < 1e5; i++) {
    await import('./heavy-module.mjs'); // æ— ç¼“å­˜ï¼Œä½†ä¼˜åŒ–åŠ è½½è·¯å¾„
  }
};
load().then(() => console.timeEnd('ESM')); // å¹³å‡è€—æ—¶çº¦890ms
```
**ç»“è®º**ï¼šé«˜é¢‘æ¨¡å—åŠ è½½åœºæ™¯ä¸‹CommonJSå…·æœ‰æ˜æ˜¾çš„ç¼“å­˜ä¼˜åŠ¿

---

#### 4. **å¾ªç¯ä¾èµ–å¤„ç†æ¨¡å¼**
**CommonJSéƒ¨åˆ†è§£æé—®é¢˜**ï¼š
```javascript
// a.js
console.log('aå¼€å§‹æ‰§è¡Œ');
exports.done = false;
const b = require('./b');
console.log('åœ¨aä¸­ï¼Œb.done =', b.done);
exports.done = true;
console.log('aç»“æŸ');

// b.js 
console.log('bå¼€å§‹æ‰§è¡Œ');
exports.done = false;
const a = require('./a');
console.log('åœ¨bä¸­ï¼Œa.done =', a.done); // æ­¤æ—¶açš„doneä¸ºfalse
exports.done = true;
console.log('bç»“æŸ');
```
è¾“å‡ºé¡ºåºè¯æ˜CommonJSå¤„ç†å¾ªç¯ä¾èµ–æ—¶å¯èƒ½å‡ºç°æœªå®Œå…¨åˆå§‹åŒ–çš„ä¸­é—´çŠ¶æ€

**ESMå®æ—¶ç»‘å®šé—­ç¯**ï¼š
```javascript
// a.mjs
console.log('aå¼€å§‹æ‰§è¡Œ');
import { bDone } from './b.mjs';
export let aDone = false;
console.log('åœ¨aä¸­ï¼Œb.done =', bDone); // ä½¿ç”¨å®æ—¶ç»‘å®šï¼Œåç»­ä¼šåŠ¨æ€æ›´æ–°
aDone = true;
console.log('aç»“æŸ');

// b.mjs 
console.log('bå¼€å§‹æ‰§è¡Œ');
import { aDone } from './a.mjs';
export let bDone = false;
console.log('åœ¨bä¸­ï¼Œa.done =', aDone); // åˆå§‹åŒ–ä¸ºundefinedï¼ˆTDZé™åˆ¶ï¼‰
bDone = true;
console.log('bç»“æŸ');
```
æ­¤æ—¶ä¼šæŠ›å‡º`ReferenceError: Cannot access 'aDone' before initialization`ï¼Œè¯´æ˜ESMé€šè¿‡TDZä¿è¯å˜é‡åˆå§‹åŒ–çš„ç¡®å®šæ€§

---

#### 5. **å·¥ç¨‹åŒ–æ·±åº¦é€‚é…**
**åŠ¨æ€å¯¼å…¥ç­–ç•¥**ï¼š
```javascript
// Webpackçš„åŠ¨æ€åŠ è½½å·®å¼‚
// CJSåŠ¨æ€å¼•å…¥
require([`pages/${pageName}`], (module) => { 
  // éœ€è¦é…ç½®ä¸Šä¸‹æ–‡ï¼ˆContextReplacementPluginï¼‰
});

// ESMåŠ¨æ€å¼•å…¥
import(`./pages/${pageName}.js`).then((module) => {
  // è‡ªåŠ¨ä»£ç åˆ†åŒ…ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰
});

// Tree-shakingæœ‰æ•ˆæ€§å¯¹æ¯”
// utils.js
export function used() { ... }
export function unused() { ... }

// ESMå¼•å…¥
import { used } from './utils'; // unusedä¼šè¢«ç§»é™¤

// CJSå¼•å…¥
const { used } = require('./utils'); // Webpackéœ€å¼€å¯æ·±åº¦åˆ†ææ‰èƒ½åˆ é™¤unused
```

---

#### 6. **Node.jsæ··åˆä½¿ç”¨é—®é¢˜**
**äº’æ“ä½œé™·é˜±æ¡ˆä¾‹**ï¼š
```javascript
// ESMä¸­å¼•å…¥CJSï¼ˆå¯è¡Œä½†æœ‰çº¦æŸï¼‰
import cjs from 'cjs-module'; // åªèƒ½é»˜è®¤å¯¼å…¥ï¼Œä¸èƒ½è§£æ„

// CJSä¸­å¼•å…¥ESMï¼ˆéœ€è¦ä½¿ç”¨åŠ¨æ€importï¼‰
(async () => {
  const esm = await import('esm-module'); 
})();

// package.jsonå­—æ®µä¼˜å…ˆçº§ï¼š
// 1. type: "module" 
// 2. .mjs/.cjsæ‰©å±•åå¼ºçº¦æŸ 
// è‹¥æœªæŒ‰æ ‡å‡†å¤„ç†ï¼Œå¯èƒ½å‡ºç°ERR_REQUIRE_ESMé”™è¯¯
```

---

#### 7. **é¡¶çº§ä½œç”¨åŸŸå¯¹æ¯”**
```javascript
// ESMçš„é¡¶å±‚è¯­å¥è¢«ä¸¥æ ¼é™åˆ¶
export let count = 0;

// âŒ æŠ¥é”™ï¼šESMæ— æ³•åŠ¨æ€æ³¨å…¥
if (Math.random() > 0.5) {
  import './moduleA'; 
}

// âœ” CommonJSå…è®¸åŠ¨æ€åŠ è½½
if (condition) {
  require('./moduleB');
}
```

---

**æ€»ç»“æ€§è¡¨æ ¼**ï¼š
| ç‰¹æ€§                | CommonJS                   | ES Modules                 |
|---------------------|----------------------------|----------------------------|
| åŠ è½½æ–¹å¼            | åŒæ­¥åŠ¨æ€åŠ è½½               | å¼‚æ­¥é™æ€åŠ è½½               |
| å¯¼å‡ºå¯¹è±¡            | å€¼çš„æ‹·è´ï¼ˆæµ…æ‹·è´ï¼‰         | å€¼çš„å®æ—¶ç»‘å®šï¼ˆå¼•ç”¨ä¼ é€’ï¼‰   |
| å¾ªç¯ä¾èµ–å¤„ç†        | å¯èƒ½å¾—åˆ°æœªå®Œå…¨å¯¼å‡ºå€¼       | å¼ºçº¦æŸï¼Œé€šè¿‡TDZé¿å…é—®é¢˜    |
| æ‰§è¡Œé¡ºåº            | è¿è¡Œåˆ°requireæ—¶æ‰§è¡Œ        | é¢„å¤„ç†->è§£æ->æ‰§è¡Œ         |
| æµè§ˆå™¨åŸç”Ÿæ”¯æŒ      | ä¸æ”¯æŒ                     | ç°ä»£æµè§ˆå™¨å…¨éƒ¨æ”¯æŒ         |
| Tree-shaking        | éœ€è¦é¢å¤–é…ç½®               | é»˜è®¤é™æ€åˆ†ææ”¯æŒ           |
| åŠ¨æ€å¯¼å…¥            | `require()`                | `import()`                 |
| thisæŒ‡å‘            | æ¨¡å—å®ä¾‹å¯¹è±¡               | undefined                  |
| é¡¶å±‚å˜é‡            | å¸¸è§„å…¨å±€å˜é‡               | ä¸¥æ ¼æ¨¡å¼ä¸‹çš„è¯æ³•ä½œç”¨åŸŸ     |

**æ€§èƒ½å–èˆå»ºè®®**ï¼š
- æœåŠ¡ç«¯å¤§æ¨¡å—ç®¡ç†ï¼šä¼˜å…ˆCommonJSï¼ˆç¼“å­˜åŠ é€Ÿå¯ç”¨ï¼‰
- æµè§ˆå™¨ç«¯SPAï¼šå¿…é€‰ESMï¼ˆTree-shakingå‡ä½“ç§¯ï¼‰
- å…¨æ ˆæ··åˆå·¥ç¨‹ï¼šç”¨Babelç»Ÿä¸€ç¼–è¯‘ä¸ºCJSï¼ˆä½†éœ€æ³¨æ„å®æ—¶ç»‘å®šå¤±æ•ˆé—®é¢˜ï¼‰

**æºç çº§æ·±åº¦å‚è€ƒ**ï¼š
- Node.jsçš„CJSåŠ è½½å™¨ï¼š`lib/internal/modules/cjs/*`
- V8çš„ESMå®ç°ï¼š`src/parsing/parser.cc`ä¸­çš„`ParseModule`æ–¹æ³•
- Webpackæ¨¡å—è§£æå™¨ï¼š`Module`åŸºç±»çš„ä¸åŒæ´¾ç”Ÿç±»å¤„ç†é€»è¾‘å·®å¼‚
