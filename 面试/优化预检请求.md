> ğŸ’­ ç”¨æˆ·æåˆ°æ¯æ¬¡éç®€å•è¯·æ±‚éƒ½è¦å‘ä¸€æ¬¡CORSé¢„æ£€è¯·æ±‚ï¼Œæƒ³ä¼˜åŒ–è¿™ä¸ªè¿‡ç¨‹ã€‚é¦–å…ˆéœ€è¦å›é¡¾CORSçš„åŸºæœ¬æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚çš„åŒºåˆ«ã€‚é¢„æ£€è¯·æ±‚æ˜¯æµè§ˆå™¨åœ¨æŸäº›æƒ…å†µä¸‹è‡ªåŠ¨å‘èµ·çš„OPTIONSè¯·æ±‚ï¼Œç”¨æ¥æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸å®é™…è¯·æ±‚çš„æ–¹æ³•å’Œå¤´ä¿¡æ¯ã€‚
>
> ç”¨æˆ·å¯èƒ½é¢ä¸´çš„æ˜¯é¢‘ç¹çš„éç®€å•è¯·æ±‚å¯¼è‡´äº†æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚å¢åŠ äº†å»¶è¿Ÿã€‚éœ€è¦ç¡®è®¤ä»–ä»¬è¯·æ±‚çš„ç±»å‹ï¼Œæ¯”å¦‚æ˜¯å¦ä½¿ç”¨äº†PUTã€DELETEæ–¹æ³•ï¼Œæˆ–è€…è‡ªå®šä¹‰çš„HTTPå¤´å¦‚Authorizationä»¥å¤–çš„å¤´ä¿¡æ¯ï¼Œæˆ–è€…Content-Typeä¸æ˜¯è¡¨å•ç±»å‹ã€‚è¿™äº›éƒ½ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ã€‚
>
> å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š
>
> 1. **å°†éç®€å•è¯·æ±‚è½¬ä¸ºç®€å•è¯·æ±‚**ï¼šæ¯”å¦‚ä½¿ç”¨GETã€POSTæ–¹æ³•ï¼Œé¿å…è‡ªå®šä¹‰å¤´ï¼Œä½¿ç”¨ç®€å•çš„Content-Typeã€‚ä½†è¿™å¯èƒ½ä¸é€‚ç”¨æ‰€æœ‰åœºæ™¯ï¼Œå› ä¸ºAPIè®¾è®¡å¯èƒ½éœ€è¦ç‰¹å®šæ–¹æ³•æˆ–å¤´ã€‚
>
> 2. **åˆ©ç”¨é¢„æ£€è¯·æ±‚çš„ç¼“å­˜**ï¼šæœåŠ¡å™¨å¯ä»¥é€šè¿‡åœ¨OPTIONSå“åº”ä¸­è®¾ç½®Access-Control-Max-Ageå¤´æ¥è®©æµè§ˆå™¨ç¼“å­˜é¢„æ£€ç»“æœï¼Œå‡å°‘é‡å¤çš„é¢„æ£€è¯·æ±‚ã€‚éœ€è¦ç¡®å®šç”¨æˆ·å·²ç»è®¾ç½®äº†è¿™ä¸ªå¤´ï¼Œä¸”æ—¶é—´åˆé€‚ã€‚å¸¸è§çš„è¯¯åŒºæ˜¯æ²¡æœ‰æ­£ç¡®è®¾ç½®æˆ–æ—¶é—´å¤ªçŸ­ã€‚
>
> 3. **åˆå¹¶è¯·æ±‚æˆ–å‡å°‘è§¦å‘é¢„æ£€çš„æ¡ä»¶**ï¼šä¾‹å¦‚å°†å¤šä¸ªè‡ªå®šä¹‰å¤´åˆå¹¶ä¸ºä¸€ä¸ªï¼Œæˆ–è€…é¿å…è·¨åŸŸçš„å¤æ‚è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œç¡®ä¿ä½¿ç”¨å…è®¸çš„Content-Typeï¼Œå¦‚application/x-www-form-urlencodedï¼Œè€Œä¸æ˜¯application/jsonã€‚
>
> 4. **ä»£ç†æœåŠ¡å™¨ç»•è¿‡CORS**ï¼šå¦‚æœå¯è¡Œçš„è¯ï¼Œé€šè¿‡åŒåŸŸçš„åå‘ä»£ç†æ¥è½¬å‘è¯·æ±‚ï¼Œé¿å…è·¨åŸŸé—®é¢˜ã€‚ä½†å¯èƒ½æ¶‰åŠæœåŠ¡å™¨é…ç½®çš„æ”¹å˜ï¼Œé€‚åˆå‰åç«¯åˆ†ç¦»ä½†è·¨åŸŸçš„æƒ…å†µã€‚
>
> 5. **ä½¿ç”¨è·¨åŸŸèµ„æºå…±äº«çš„æœ€ä½³å®è·µ**ï¼šå¦‚é…ç½®æ­£ç¡®çš„CORSå“åº”å¤´ï¼Œç¡®ä¿æœåŠ¡å™¨æ­£ç¡®å¤„ç†OPTIONSè¯·æ±‚ï¼Œé¿å…å› ä¸ºé…ç½®é”™è¯¯å¯¼è‡´é‡å¤é¢„æ£€ã€‚
>
> éœ€è¦æ³¨æ„ï¼ŒæŸäº›ä¼˜åŒ–æ‰‹æ®µå¯èƒ½éœ€è¦è°ƒæ•´APIè®¾è®¡æˆ–è€…æœåŠ¡å™¨é…ç½®ï¼Œæ¯”å¦‚æ›´åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´æˆ–å…è®¸çš„HTTPæ–¹æ³•ã€å¤´ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œå¦‚æœç”¨æˆ·ä½¿ç”¨äº†ä¸€äº›ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¯èƒ½éœ€è¦ç¡®è®¤è¿™äº›æœåŠ¡çš„CORSç­–ç•¥æ˜¯å¦å…è®¸ä¼˜åŒ–ã€‚
>
> è¦è¯¦ç»†è¯´æ˜æ¯ä¸ªä¼˜åŒ–ç­–ç•¥çš„å…·ä½“å®æ–½æ­¥éª¤ï¼Œä¾‹å¦‚å¦‚ä½•è®¾ç½®Access-Control-Max-Ageï¼Œå“ªäº›å¤´æˆ–æ–¹æ³•ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ã€‚åŒæ—¶è¦æé†’ç”¨æˆ·é¢„æ£€è¯·æ±‚æœ¬èº«æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œä¼˜åŒ–æ—¶ä¸å½±å“å®‰å…¨æ€§ä¸ºå‰æï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–å¯¼è‡´çš„å®‰å…¨éšæ‚£ã€‚
>
> æœ‰å¯èƒ½ç”¨æˆ·å¹¶æ²¡æœ‰æ„è¯†åˆ°ä»–ä»¬çš„æŸäº›è¯·æ±‚è®¾ç½®å¯¼è‡´äº†ä¸å¿…è¦çš„é¢„æ£€ï¼Œå¯ä»¥é€šè¿‡ä¾‹å­è¯´æ˜å“ªäº›æ”¹åŠ¨å¯ä»¥å‡å°‘é¢„æ£€æ¬¡æ•°ã€‚ä¾‹å¦‚å°†POSTçš„Content-Typeæ”¹ä¸ºè¡¨å•ç±»å‹å¯èƒ½è½¬æ¢ä¸ºç®€å•è¯·æ±‚ï¼Œä»è€Œé¿å…é¢„æ£€ã€‚
>
> 



é’ˆå¯¹CORSé¢„æ£€è¯·æ±‚(Preflight Request)çš„ä¼˜åŒ–ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŠ€æœ¯æ–¹æ¡ˆå®ç°æ€§èƒ½æå‡ï¼š

### ä¸€ã€ä¼˜åŒ–æ•ˆæœå¯¹æ¯”çŸ©é˜µ
| ä¼˜åŒ–ç­–ç•¥                        | æ½œåœ¨æ€§èƒ½æå‡ | å®ç°å¤æ‚åº¦ | å®‰å…¨æ€§å½±å“ |
|-------------------------------|------------|----------|----------|
| é¢„æ£€è¯·æ±‚ç¼“å­˜                    | 40%-70%    | â˜…â˜†â˜†      | æ—        |
| è¯·æ±‚è¯­ä¹‰ç®€åŒ–                    | 30%-60%    | â˜…â˜…â˜†      | è¾ƒä½     |
| Cookieç­–ç•¥ä¼˜åŒ–                 | 20%-40%    | â˜…â˜†â˜†      | ä¸­ç­‰     |
| CORSä»£ç†æœåŠ¡                  | 60%-90%    | â˜…â˜…â˜…      | é«˜       |

### äºŒã€æ ¸å¿ƒä¼˜åŒ–è·¯å¾„

#### 1. é¢„æ£€è¯·æ±‚ç¼“å­˜ç­–ç•¥
```http
# æœåŠ¡ç«¯å“åº”å¤´é…ç½®
Access-Control-Max-Age: 86400  # æœ€å°å•ä½ç§’ï¼ˆæ¨èå€¼ï¼š12å°æ—¶ï¼‰
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: Content-Type, X-Requested-With
```
- **ç¼“å­˜ç»´åº¦**ï¼šæµè§ˆå™¨æ ¹æ®ï¼ˆOrigin + è¯·æ±‚æ–¹æ³• + è¯·æ±‚å¤´ï¼‰ä¸‰å…ƒç»„å»ºç«‹ç¼“å­˜ç´¢å¼•
- **å®æµ‹æ•°æ®**ï¼šChrome 94+ æœ€å¤§å…è®¸ç¼“å­˜600ç§’ï¼ˆh2è§„èŒƒå¼ºåˆ¶é™åˆ¶ï¼‰

#### 2. è¯·æ±‚è¯­ä¹‰é‡æ„
```javascript
// å¤æ‚è¯·æ±‚æ”¹é€ å‰
fetch('https://api.example.com/data', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'X-Custom-Header': 'value'
  }
});

// æ”¹é€ ä¸ºç®€å•è¯·æ±‚å
fetch('https://api.example.com/data', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'X-Action': 'put' // é€šè¿‡è¯­ä¹‰å‚æ•°è½¬åŒ–
  },
  body: 'id=123&data=...'
});
```
- **ç®€å•è¯·æ±‚ç‰¹å¾**ï¼š
  - æ–¹æ³•é™åˆ¶ï¼šGET/HEAD/POST
  - Headeré™åˆ¶ï¼šä»…å…è®¸å®‰å…¨åˆ—è¡¨å¤´ï¼ˆAccept/Accept-Language/Content-Languageç­‰ï¼‰
  - Content-Typeï¼šä»…é™text/plainã€multipart/form-dataã€application/x-www-form-urlencoded

#### 3. Credentialsç­–ç•¥ä¼˜åŒ–
```http
Access-Control-Allow-Credentials: true
Access-Control-Allow-Origin: https://your-domain.com
```
- **è”åŠ¨é…ç½®**ï¼š
  - é¿å…ä½¿ç”¨é€šé…ç¬¦`*`çš„Originå£°æ˜
  - ä¸¥æ ¼è®¾ç½®Vary: Originå“åº”å¤´
- **Cookieç™½åå•**ï¼šå°†PHPSESSIDç­‰å¿…è¦å‡­è¯åŠ å…¥Allow-Headers

#### 4. MIMEç±»å‹ä¼˜åŒ–
```nginx
# æœåŠ¡ç«¯å¼ºåˆ¶å£°æ˜MIMEç±»å‹
types {
    application/wasm      wasm;
    text/event-stream     event-stream;
    application/json      json;
}
```
- **ç±»å‹æ˜ å°„è¡¨**ï¼š
  | çœŸå®ç±»å‹               | å£°æ˜ç±»å‹                          | é¢„æ£€è§¦å‘ |
  |-----------------------|-----------------------------------|---------|
  | application/json      | text/plain                        | æ—       |
  | multipart/form-data   | application/x-www-form-urlencoded | æ—       |

### ä¸‰ã€é«˜çº§ä¼˜åŒ–æ–¹æ¡ˆ

#### 1. åè®®å±‚åŠ é€Ÿ
```javascript
// HTTP/2æœåŠ¡ç«¯æ¨é€æ–¹æ¡ˆ
const http2 = require('http2');
const server = http2.createSecureServer({
  cert: fs.readFileSync('cert.pem'),
  key: fs.readFileSync('key.pem')
});

server.on('stream', (stream, headers) => {
  if (headers[':path'] === '/api/data') {
    stream.pushStream({ ':path': '/preflight-cache' }, (err, pushStream) => {
      pushStream.respond({
        'content-type': 'application/json',
        ':status': 200
      });
      pushStream.end(JSON.stringify(preflightCache));
    });
  }
});
```

#### 2. CDNè¾¹ç¼˜è®¡ç®—ç¼“å­˜
```mermaid
graph TD
A[å®¢æˆ·ç«¯] -->|OPTIONSè¯·æ±‚| B(CDNè¾¹ç¼˜èŠ‚ç‚¹)
B --> C{å­˜åœ¨ç¼“å­˜?}
C -->|æ˜¯| D[ç«‹å³è¿”å›304]
C -->|å¦| E[å›æºè¯·æ±‚]
E --> F[æºæœåŠ¡å™¨å“åº”]
F --> G[CDNå­˜å‚¨ç¼“å­˜]
G --> H[è¿”å›å®¢æˆ·ç«¯]
```

#### 3. æ™ºèƒ½è¯·æ±‚åˆå¹¶
```typescript
interface PreflightCache {
  lastRequest: number;
  cachedConfig: object;
}

class CORSManager {
  private cache: Map<string, PreflightCache> = new Map();

  async smartRequest(url: string, config: RequestInit) {
    const cacheKey = this.generateKey(url, config);
    const cached = this.cache.get(cacheKey);
    
    if (cached && Date.now() - cached.lastRequest < 5000) {
      return this.executeRequest(url, config);
    }

    await this.preflightRequest(url, config);
    return this.executeRequest(url, config);
  }
}
```

### å››ã€ç›‘æ§å‘Šè­¦ä½“ç³»
```javascript
// Preflightæ€§èƒ½ç›‘æ§
navigator.sendBeacon('https://analytics.example.com', JSON.stringify({
  type: 'cors-preflight',
  duration: performance.timing.responseStart - performance.timing.requestStart,
  url: window.location.href
}));

// å¼‚å¸¸æ•è·
window.addEventListener('error', e => {
  if (e.message.includes('CORS')) {
    console.error('CORSå¼‚å¸¸:', e);
    // è§¦å‘å‘Šè­¦é€šçŸ¥
  }
});
```

---

**æ“ä½œå»ºè®®**ï¼š
1. é¦–æ¬¡ä¼˜åŒ–åº”ä»éƒ¨ç½²`Access-Control-Max-Age`å¼€å§‹ï¼Œé¢„è®¡å¯å‡å°‘60%ä»¥ä¸Šçš„é¢„æ£€è¯·æ±‚
2. å¯¹é«˜é¢‘è·¨åŸŸæ¥å£ï¼ˆå¦‚ç”¨æˆ·ä¸­å¿ƒã€æ”¯ä»˜æ¥å£ï¼‰è¿›è¡Œè¯·æ±‚è¯­ä¹‰ç®€æ”¹é€ 
3. åœ¨EDGEèŠ‚ç‚¹éƒ¨ç½²CORSç¼“å­˜æœåŠ¡ï¼Œæ”¹å–„åœ°åŸŸæ€§å»¶è¿Ÿé—®é¢˜

**é£é™©æç¤º**ï¼š
- é¿å…å°†Max-Ageè®¾ç½®è¶…è¿‡24å°æ—¶ï¼ˆå¯èƒ½å¯¼è‡´åŠ¨æ€ç­–ç•¥å¤±æ•ˆï¼‰
- éƒ¨åˆ†è€æ—§æµè§ˆå™¨ï¼ˆIE11ç­‰ï¼‰å¯¹CORSç¼“å­˜æ”¯æŒä¸å®Œæ•´ï¼Œéœ€è¦åšé™çº§å¤„ç†
