> ðŸ’­ å—¯ï¼ŒçŽ°åœ¨æˆ‘è¦ä»”ç»†æ€è€ƒä¸€ä¸‹å…³äºŽTCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹çš„é—®é¢˜ã€‚é¦–å…ˆï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºŽç½‘ç»œåŸºç¡€çŸ¥è¯†çš„ï¼Œå±žäºŽTCPåè®®çš„è¿žæŽ¥å»ºç«‹å’Œæ–­å¼€è¿‡ç¨‹ã€‚è®°ä½ï¼Œåœ¨é¢è¯•ä¸­å›žç­”è¿™ä¸ªé—®é¢˜æ—¶ï¼Œéœ€è¦æ¸…æ™°ã€æœ‰æ¡ç†åœ°é˜è¿°åŽŸç†ï¼ŒåŒæ—¶æ·±å…¥ç†è§£æ¯ä¸ªæ­¥éª¤çš„å¿…è¦æ€§ã€‚
>
> é¦–å…ˆï¼Œä¸‰æ¬¡æ¡æ‰‹ã€‚ä¸‰æ¬¡æ¡æ‰‹æ˜¯ç”¨æ¥å»ºç«‹TCPè¿žæŽ¥çš„ã€‚è¿‡ç¨‹ä¸­æœ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸¤æ–¹å‚ä¸Žã€‚æŒ‰ç…§ä¹‹å‰çš„ç†è§£ï¼Œä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸€æ­¥æ˜¯å®¢æˆ·ç«¯å‘é€SYNåŒ…ï¼Œè¡¨ç¤ºè¯·æ±‚å»ºç«‹è¿žæŽ¥ï¼›ç¬¬äºŒæ­¥æ˜¯æœåŠ¡å™¨å›žåº”SYN-ACKåŒ…ï¼Œç¡®è®¤æ”¶åˆ°å¹¶åŒæ„å»ºç«‹è¿žæŽ¥ï¼›ç¬¬ä¸‰æ­¥æ˜¯å®¢æˆ·ç«¯å‘é€ACKåŒ…ï¼Œç¡®è®¤æœåŠ¡å™¨çš„å›žåº”ã€‚è¿™é‡Œçš„å…³é”®é—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹è€Œä¸æ˜¯ä¸¤æ¬¡ï¼Ÿæˆ‘ä¹Ÿå¬è¯´è¿‡ä¸¤æ¬¡æ¡æ‰‹å¯èƒ½å¼•å‘çš„åŽ†å²é—®é¢˜ï¼Œæ¯”å¦‚æ—§çš„é‡å¤è¿žæŽ¥è¯·æ±‚å¯¼è‡´çš„æ··ä¹±æƒ…å†µã€‚
>
> æŽ¥ä¸‹æ¥æƒ³ï¼Œä¸¤æ¬¡æ¡æ‰‹å¯èƒ½ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ã€‚æ¯”å¦‚ï¼Œå¦‚æžœå®¢æˆ·ç«¯å‘é€çš„SYNåŒ…åœ¨ç½‘ç»œä¸­å»¶è¿Ÿï¼Œå®¢æˆ·ç«¯å¯èƒ½é‡ä¼ åŽå»ºç«‹è¿žæŽ¥ï¼Œè€Œå»¶è¿Ÿçš„SYNåŒ…ä¹‹åŽåˆ°è¾¾æœåŠ¡å™¨ï¼Œå¯¼è‡´æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªä¸å¿…è¦çš„è¿žæŽ¥ã€‚ä½†TCPè®¾è®¡ä¸Šåº”è¯¥å¤„ç†è¿™ç§é‡å¤çš„SYNï¼Œä½†è¿™æ—¶å€™å¯èƒ½è¿˜æ˜¯éœ€è¦ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ¥ç¡®ä¿åŒæ–¹çš„åŒæ­¥ã€‚
>
> ç„¶åŽæ˜¯å››æ¬¡æŒ¥æ‰‹çš„é—®é¢˜ã€‚ç»ˆæ­¢TCPè¿žæŽ¥éœ€è¦å››æ¬¡æŠ¥æ–‡äº¤æ¢ï¼šå®¢æˆ·ç«¯å‘é€FINï¼ŒæœåŠ¡å™¨å›žåº”ACKï¼Œç„¶åŽæœåŠ¡å™¨å‘é€FINï¼Œå®¢æˆ·ç«¯å›žåº”ACKã€‚é—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆéœ€è¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿè€Œä¸‰æ¬¡æŒ¥æ‰‹æ˜¯å¦å¯è¡Œï¼Ÿæ¯”å¦‚ï¼ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°å®¢æˆ·ç«¯çš„FINåŽï¼Œå¯èƒ½è¿˜æœ‰æ•°æ®éœ€è¦å‘é€ï¼Œæ‰€ä»¥å…ˆæŠŠACKå‘é€å›žåŽ»ï¼Œç­‰æ•°æ®å¤„ç†å®Œå†å‘é€è‡ªå·±çš„FINã€‚æ‰€ä»¥åœ¨æ–­å¼€è¿žæŽ¥æ—¶ï¼Œè¢«åŠ¨å…³é—­çš„ä¸€æ–¹å¯èƒ½éœ€è¦æ—¶é—´æ¥å…³é—­è‡ªå·±çš„è¿žæŽ¥ï¼Œå› æ­¤éœ€è¦å°†ACKå’ŒFINåˆ†å¼€å‘é€ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½åˆå¹¶ä¸ºä¸‰æ¬¡çš„åŽŸå› ã€‚
>
> è¿™æ—¶å€™å¯èƒ½éœ€è¦è¿›ä¸€æ­¥æ€è€ƒï¼šä¸ºä»€ä¹ˆåœ¨å»ºç«‹è¿žæŽ¥çš„æ—¶å€™å¯ä»¥ä¸‰æ¬¡ï¼Œè€Œæ–­å¼€éœ€è¦å››æ¬¡ï¼Ÿå»ºç«‹è¿žæŽ¥æ—¶ï¼Œä¸‰æ¬¡æ¡æ‰‹æ˜¯å› ä¸ºSYNå’ŒACKå¯ä»¥åˆå¹¶æˆä¸€ä¸ªæŠ¥æ–‡å‘é€ï¼ˆæ¯”å¦‚æœåŠ¡å™¨æ”¶åˆ°SYNåŽåŒæ—¶å‘é€SYN-ACKï¼‰ï¼Œä½†å…³é—­è¿žæŽ¥æ—¶ï¼Œå½“æ”¶åˆ°å¯¹æ–¹çš„FINåŽï¼Œå¯èƒ½è‡ªèº«å¤„äºŽåŠå…³é—­çŠ¶æ€ï¼Œæ­¤æ—¶å¯èƒ½è¿˜éœ€è¦å‘é€æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦å…ˆå‘é€ACKï¼Œç­‰æ•°æ®å‘é€å®Œæ¯•åŽå†å‘é€FINï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæ­¥éª¤ä¸èƒ½åˆå¹¶ï¼Œå¯¼è‡´éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚
>
> å†æ·±å…¥ä¸€äº›çš„è¯ï¼Œæ¯”å¦‚TIME_WAITçŠ¶æ€çš„æ„ä¹‰ã€‚å®¢æˆ·ç«¯åœ¨å‘é€æœ€åŽçš„ACKåŽä¼šè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œç­‰å¾…2MSLæ—¶é—´ï¼Œç¡®ä¿å¯¹æ–¹æ”¶åˆ°ACKï¼Œå¦‚æžœæ²¡æœ‰ï¼ŒæœåŠ¡å™¨ä¼šé‡å‘FINï¼Œè¿™æ ·å®¢æˆ·ç«¯å¯ä»¥é‡æ–°å‘é€ACKï¼Œä»¥å…é€ æˆæ—§çš„æŠ¥æ–‡å¹²æ‰°æ–°çš„è¿žæŽ¥ã€‚è¿™ä¹Ÿæ˜¯å››æ¬¡æŒ¥æ‰‹ä¸­é‡è¦çš„éƒ¨åˆ†ã€‚
>
> ç„¶åŽè¦æ€è€ƒå¯èƒ½çš„ä¾‹å¤–æƒ…å†µæˆ–ä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå››æ¬¡æŒ¥æ‰‹ä¸­çš„æœåŠ¡å™¨æ˜¯å¦å¯ä»¥åˆå¹¶ACKå’ŒFINï¼Ÿå¦‚æžœæœåŠ¡å™¨åœ¨æ”¶åˆ°å®¢æˆ·ç«¯çš„FINæ—¶ï¼Œå·²ç»æ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥å°†ACKå’Œè‡ªå·±çš„FINåˆå¹¶ä¸ºä¸€ä¸ªæŠ¥æ–‡å‘é€ï¼Œè¿™æ ·å˜æˆä¸‰æ¬¡æŒ¥æ‰‹ã€‚è¿™æ˜¯å¦å¯è¡Œï¼Ÿåœ¨å®žé™…æƒ…å†µä¸‹ï¼Œå¦‚æžœæœåŠ¡å™¨çš„ACKå’ŒFINä¹‹é—´æ²¡æœ‰æ•°æ®éœ€è¦ä¼ è¾“ï¼Œæ˜¯å¦èƒ½ä¸€èµ·å‘é€ï¼Ÿç†è®ºä¸Šæ˜¯å¯ä»¥çš„ï¼Œè¿™æ ·å››æ¬¡æŒ¥æ‰‹å¯èƒ½å˜æˆä¸‰æ¬¡ã€‚è¿™ç§æƒ…å†µå¯èƒ½å‡ºçŽ°åœ¨è¢«åŠ¨å…³é—­æ–¹å¤„ç†å®Œæ‰€æœ‰æ•°æ®åŽç«‹å³å‘é€FINçš„æƒ…å†µã€‚ä¾‹å¦‚ï¼Œåœ¨Linuxä¸­ï¼Œå½“è¢«åŠ¨å…³é—­æ–¹è°ƒç”¨close()å‡½æ•°æ—¶ï¼Œä¼šå‘é€FINï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯å¦å¯èƒ½å°†ACKå’ŒFINåˆå¹¶ï¼Œå–å†³äºŽå¤„ç†é€»è¾‘å’ŒTCPå®žçŽ°ã€‚
>
> ä¸è¿‡ï¼ŒTCPåè®®ä¸­å››æ¬¡æŒ¥æ‰‹å¹¶ä¸æŽ’æ–¥ACKå’ŒFINåˆå¹¶çš„æƒ…å†µï¼Œåªæ˜¯é€šå¸¸æƒ…å†µä¸‹ä¸¤è€…æ˜¯åˆ†å¼€å‘é€çš„ï¼Œå› æ­¤åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éœ€è¦å››æ¬¡äº¤äº’ï¼Œä½†æœ‰æ—¶å¯ä»¥åˆå¹¶ï¼Œä¸è¿‡å¹¶éžæ€»æ˜¯å¯è¡Œï¼Œæ¯”å¦‚å½“è¢«åŠ¨å…³é—­æ–¹è¿˜éœ€è¦å¤„ç†å‰©ä½™æ•°æ®æ—¶ï¼Œå°±ä¸èƒ½ç«‹å³å‘é€FINï¼Œå¿…é¡»å‘é€ACKç¡®è®¤å®¢æˆ·ç«¯çš„FINï¼Œå¤„ç†å®Œæ•°æ®åŽå†å‘é€FINã€‚å› æ­¤ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯å››æ¬¡æŒ¥æ‰‹ã€‚
>
> æ€»ç»“ä¸‹æ¥ï¼Œä¸‰æ¬¡æ¡æ‰‹ç¡®ä¿åŒæ–¹éƒ½ç¡®è®¤å¯¹æ–¹çš„æ”¶å‘èƒ½åŠ›æ­£å¸¸ï¼Œè€Œå››æ¬¡æŒ¥æ‰‹ä¿è¯åŒæ–¹çš„æ•°æ®ä¼ è¾“å®Œå…¨ç»“æŸï¼Œå¹¶ä¸”æ­£ç¡®å…³é—­è¿žæŽ¥ã€‚
>
> æ˜¯å¦æœ‰å…¶ä»–å¯èƒ½çš„é”™è¯¯æƒ…å†µæˆ–ä¾‹å¤–å‘¢ï¼Ÿæ¯”å¦‚ï¼Œå¦‚æžœä¸€æ–¹åŒæ—¶å‘é€FINæ€Žä¹ˆåŠžï¼Ÿè¿™ä¼šå¯¼è‡´è¿›å…¥åŒæ—¶å…³é—­çš„çŠ¶æ€ï¼Œæ­¤æ—¶å¤„ç†å¯èƒ½ä¸åŒï¼Œä½†è¿™ç±»æƒ…å†µå±žäºŽè¾ƒä¸ºç‰¹æ®Šçš„æ¡ˆä¾‹ï¼Œä¸åœ¨å¸¸è§„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹çš„è®¨è®ºèŒƒå›´å†…ã€‚
>
> æœ€åŽï¼Œè¦ç»“åˆSYNæ´ªæ³›æ”»å‡»ä¹‹ç±»çš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚ä¸‰æ¬¡æ¡æ‰‹ä¸­çš„æœåŠ¡å™¨åœ¨æ”¶åˆ°SYNåŽä¼šè¿›å…¥åŠè¿žæŽ¥çŠ¶æ€ï¼Œå¯èƒ½å¯¼è‡´èµ„æºè€—å°½ï¼Œå› æ­¤éœ€è¦SYN Cookieç­‰æœºåˆ¶æ¥é˜²æŠ¤ã€‚ä¸è¿‡è¿™å¯èƒ½å±žäºŽè¡ç”Ÿé—®é¢˜ï¼Œè€Œä¸æ˜¯ä¸‰æ¬¡æ¡æ‰‹æœ¬èº«çš„å¿…è¦æ€§çš„ç›´æŽ¥åŽŸå› ã€‚
>
> é€šè¿‡è¿™äº›æ€è€ƒï¼Œå¯ä»¥ç³»ç»Ÿåœ°ç»„ç»‡å‡ºä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹çš„åŽŸç†ã€å¿…è¦æ€§ä»¥åŠå¯èƒ½çš„é—®é¢˜ï¼Œä»Žè€Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„å›žç­”ã€‚
>
> 



---

### ä¸€ã€ä¸‰æ¬¡æ¡æ‰‹ï¼ˆThree-Way Handshakeï¼‰

#### 1. æ ¸å¿ƒè¿‡ç¨‹
1. **SYNï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ï¼‰**  
   - å®¢æˆ·ç«¯å‘é€ **SYN=1, Seq=x**ï¼ˆéšæœºåˆå§‹åŒ–åºåˆ—å·ï¼‰
2. **SYN-ACKï¼ˆæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ï¼‰**  
   - æœåŠ¡ç«¯å›žåº” **SYN=1, ACK=1, Seq=y, Ack=x+1**
3. **ACKï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ï¼‰**  
   - å®¢æˆ·ç«¯ç¡®è®¤ **ACK=1, Seq=x+1, Ack=y+1**

#### 2. ä¸ºä»€ä¹ˆå¿…é¡»ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ
**å…³é”®ç‚¹ï¼šå…¨åŒå·¥é€šä¿¡çš„å¯é æ€§éªŒè¯**  
é€šè¿‡ä¸‰æ¬¡äº¤äº’ç¡®è®¤åŒæ–¹å…·å¤‡ **æ•°æ®æ”¶å‘èƒ½åŠ›**ï¼Œå¹¶ **åŒæ­¥åˆå§‹åºåˆ—å·**ï¼š

| è½®æ¬¡ | éªŒè¯å†…å®¹                  | é˜²æ­¢çš„é—®é¢˜                     |
|------|-------------------------|-----------------------------|
| 1â†’2  | æœåŠ¡ç«¯éªŒè¯å®¢æˆ·ç«¯å‘é€èƒ½åŠ›       | ä¸¢å¼ƒæ— æ•ˆè¿žæŽ¥è¯·æ±‚                 |
| 2â†’3  | å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯æ”¶å‘èƒ½åŠ›       | é˜²æ­¢åŽ†å²ï¼ˆæ—§ï¼‰SYNå¯¼è‡´çš„èµ„æºå ç”¨     |
| 3â†’1  | æœåŠ¡ç«¯ç¡®è®¤å®¢æˆ·ç«¯æŽ¥æ”¶èƒ½åŠ›       | é¿å…åŠå¼€è¿žæŽ¥ï¼ˆHalf-Openï¼‰       |

> **æ¡ˆä¾‹**ï¼š  
> è‹¥åªéœ€ä¸¤æ¬¡æ¡æ‰‹ï¼šå½“å®¢æˆ·ç«¯é‡å‘çš„SYNï¼ˆæ—§ï¼‰åˆ°è¾¾æœåŠ¡ç«¯æ—¶ï¼ŒæœåŠ¡ç«¯å•æ–¹é¢å»ºç«‹è¿žæŽ¥ï¼Œè€Œå®¢æˆ·ç«¯å·²æ”¾å¼ƒè¯¥è¿žæŽ¥ï¼Œå¯¼è‡´æœåŠ¡ç«¯èµ„æºæµªè´¹ã€‚

#### 3. æŠ€æœ¯ç²¾è¦
```plaintext
åˆå§‹åŒ–åºåˆ—å·ï¼ˆISNï¼‰ç®—æ³•ï¼š
ä½¿ç”¨åŸºäºŽæ—¶é’Ÿçš„éšæœºç”Ÿæˆå™¨ï¼ˆRFC 6528ï¼‰ï¼Œé˜²æ­¢åºåˆ—å·é¢„æµ‹æ”»å‡»ã€‚
```

---

### äºŒã€å››æ¬¡æŒ¥æ‰‹ï¼ˆFour-Way Terminationï¼‰

#### 1. æ ‡å‡†æµç¨‹
1. **FINï¼ˆä¸»åŠ¨æ–¹ â†’ è¢«åŠ¨æ–¹ï¼‰**  
   - ä¸»åŠ¨æ–¹å‘é€FINæŠ¥æ–‡ï¼ˆ**FIN=1, Seq=u**ï¼‰
2. **ACKï¼ˆè¢«åŠ¨æ–¹ â†’ ä¸»åŠ¨æ–¹ï¼‰**  
   - è¢«åŠ¨æ–¹å›žåº”ACKæŠ¥æ–‡ï¼ˆ**ACK=1, Ack=u+1**ï¼‰
3. **FINï¼ˆè¢«åŠ¨æ–¹ â†’ ä¸»åŠ¨æ–¹ï¼‰**  
   - è¢«åŠ¨æ–¹å‘é€FINæŠ¥æ–‡ï¼ˆ**FIN=1, Seq=w**ï¼‰
4. **ACKï¼ˆä¸»åŠ¨æ–¹ â†’ è¢«åŠ¨æ–¹ï¼‰**  
   - ä¸»åŠ¨æ–¹å›žåº”ACKæŠ¥æ–‡ï¼ˆ**ACK=1, Ack=w+1**ï¼‰

#### 2. ä¸ºä»€ä¹ˆéœ€è¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿ
**æ ¹æœ¬åŽŸå› ï¼šTCPå…¨åŒå·¥ç‰¹æ€§ä¸‹çš„ç‹¬ç«‹å…³é—­**

| é˜¶æ®µ       | æ“ä½œé€»è¾‘                                   |
|------------|------------------------------------------|
| ç¬¬ä¸€æ¬¡FIN   | ä¸»åŠ¨æ–¹åœæ­¢å‘é€æ•°æ®ï¼Œä½†å¯æŽ¥æ”¶æ•°æ®ï¼ˆâ†’ FIN_WAIT_1ï¼‰ |
| ç¬¬äºŒæ¬¡ACK   | è¢«åŠ¨æ–¹ç¡®è®¤å…³é—­è¯·æ±‚ï¼Œå‡†å¤‡ç»ˆæ­¢å‘é€ï¼ˆâ†’ CLOSE_WAITï¼‰ |
| ç¬¬ä¸‰æ¬¡FIN   | è¢«åŠ¨æ–¹å®Œæˆæ•°æ®å‘é€ï¼Œæ­£å¼å…³é—­ï¼ˆâ†’ LAST_ACKï¼‰      |
| ç¬¬å››æ¬¡ACK   | ä¸»åŠ¨æ–¹æœ€ç»ˆç¡®è®¤ï¼ˆâ†’ TIME_WAITï¼‰              |

> **æ¡ˆä¾‹**ï¼š  
> è‹¥åˆå¹¶ACKä¸ŽFINï¼šåœ¨è¢«åŠ¨æ–¹ä»æœ‰æ•°æ®å¾…å‘é€æ—¶ï¼Œæå‰å‘é€FINä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

#### 3. é«˜çº§é—®é¢˜ï¼šä¸‰æ¬¡æŒ¥æ‰‹æ˜¯å¦å­˜åœ¨ï¼Ÿ
**å¯èƒ½æ€§æ¡ä»¶**ï¼šè¢«åŠ¨æ–¹æ— éœ€å‘é€ä»»ä½•æ•°æ®ï¼ˆå¦‚HTTPçŸ­è¿žæŽ¥å“åº”å®Œæ¯•ï¼‰  
```plaintext
å½“æœåŠ¡ç«¯æ”¶åˆ°FINåŽï¼Œè‹¥ç«‹å³å®Œæˆæ•°æ®å¤„ç†ï¼š
å¯ç›´æŽ¥å‘é€ **ACK+FINåˆå¹¶æŠ¥æ–‡**ï¼ˆWiresharkä¸­å¯è§TCP Flags [FIN, ACK]ï¼‰ â†’ å˜ä¸ºä¸‰æ¬¡äº¤äº’ã€‚
```

---

### ä¸‰ã€TIME_WAITæ·±åº¦å‰–æž

#### 1. å­˜åœ¨æ„ä¹‰
- **å¯é æ€§ä¿éšœ**ï¼šå…è®¸è¢«åŠ¨æ–¹é‡ä¼ FINï¼ˆè‹¥ä¸»åŠ¨æ–¹ç¬¬å››ACKä¸¢å¤±ï¼‰
- **æ—§æŠ¥æ–‡æ¸…ç†**ï¼šç­‰å¾…2MSLï¼ˆæœ€é•¿æŠ¥æ–‡å¯¿å‘½ï¼‰ç¡®ä¿ç½‘ç»œä¸­æ—§æ•°æ®åŒ…æ¶ˆäº¡

#### 2. æ•°å­¦è®¡ç®—
```plaintext
Linuxé»˜è®¤ MSL=60s â†’ TIME_WAIT=2*60=120s
è°ƒæ•´æ–¹æ³•ï¼šsysctl net.ipv4.tcp_fin_timeout
```

#### 3. ç”Ÿäº§é—®é¢˜
**TIME_WAITè¿‡å¤šï¼ˆé«˜å¹¶å‘çŸ­è¿žæŽ¥åœºæ™¯ï¼‰**  
- **è§£å†³æ–¹æ¡ˆ**ï¼š  
  - å¯ç”¨`tcp_tw_reuse`ï¼ˆè°¨æ…Žä½¿ç”¨ï¼‰
  - åº”ç”¨å±‚è¿žæŽ¥æ± ï¼ˆå¦‚Nginx keepaliveï¼‰
  
---

### å››ã€åè®®å®‰å…¨ä¸Žæ”»å‡»é˜²å¾¡

#### 1. SYN Floodæ”»å‡»
**åŽŸç†**ï¼šä¼ªé€ æµ·é‡SYNå ç”¨æœåŠ¡ç«¯åŠè¿žæŽ¥é˜Ÿåˆ—ï¼ˆ`/proc/sys/net/ipv4/tcp_max_syn_backlog`ï¼‰  
**é˜²æŠ¤**ï¼šSYN Cookieæœºåˆ¶ï¼ˆæ— çŠ¶æ€éªŒè¯SYNåˆæ³•æ€§ï¼‰

#### 2. FINæ”»å‡»é˜²å¾¡
```plaintext
é€šè¿‡iptablesé™åˆ¶å¼‚å¸¸FINåŒ…é€ŸçŽ‡ï¼š
iptables -A INPUT -p tcp --tcp-flags FIN FIN -m limit --limit 1/s -j ACCEPT
```

---

### äº”ã€çŽ°ä»£åè®®ä¼˜åŒ–ï¼ˆTCP Fast Openï¼‰

#### 1. æ ¸å¿ƒåŽŸç†ï¼ˆRFC 7413ï¼‰
```plaintext
é¦–æ¬¡æ¡æ‰‹æºå¸¦æ•°æ®ï¼ˆ0-RTTï¼‰ï¼Œå‡å°‘å»¶è¿Ÿï¼š
1. Clientå‘é€SYNï¼ˆæºå¸¦TFO Cookieè¯·æ±‚ï¼‰
2. Serverç”ŸæˆCookieï¼ˆåŠ å¯†æ—¶é—´æˆ³+å¯†é’¥ï¼‰
3. Clientç¼“å­˜Cookieï¼ŒåŽç»­SYNå¯ç›´æŽ¥æºå¸¦æ•°æ®
```

#### 2. éƒ¨ç½²æ–¹æ³•ï¼ˆLinuxï¼‰
```bash
sysctl net.ipv4.tcp_fastopen=3  # å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å‡å¯ç”¨
```

---

### å…­ã€å…³é”®æºç å®žçŽ°

#### 1. Linuxå†…æ ¸-ä¸‰æ¬¡æ¡æ‰‹ï¼ˆ`net/ipv4/tcp_input.c`ï¼‰
```c
void tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb) {
    switch (sk->sk_state) {
    case TCP_LISTEN:
        if (th->syn) {
            // å¤„ç†SYNç”ŸæˆSYN-ACK
            tcp_v4_send_synack(sk, skb);
        }
        break;
    case TCP_SYN_SENT:
        if (th->ack) {
            // éªŒè¯ACKæœ‰æ•ˆæ€§
            tcp_ack(sk, skb, FLAG_SLOWPATH);
        }
        break;
    }
}
```

#### 2. Windows TCP/IPå †æ ˆ-å››æ¬¡æŒ¥æ‰‹
```csharp
// å¼•ç”¨NDISé©±åŠ¨ä»£ç ï¼ˆç®€åŒ–ï¼‰
VOID TcpCloseCompletionHandler(_In_ PTCB tcb) {
    if (STATE_LAST_ACK == tcb->state) {
        tcb->state = TCP_CLOSED;
        IoCompleteRequest(tcb->irp, IO_NO_INCREMENT);
    }
}
```

---

### æ€»ç»“å›¾ä¾‹

```
ä¸‰æ¬¡æ¡æ‰‹:
client            server
  |--SYN(x)--------->|  (SYN_SENT â†’ SYN_RCVD)
  |<-----SYN(y)+ACK--|  
  |--ACK(y+1)------->|  (ESTABLISHEDåŒæ–¹)

å››æ¬¡æŒ¥æ‰‹:
client            server
  |--FIN(u)--------->|  (FIN_WAIT_1 â†’ CLOSE_WAIT)
  |<-----ACK(u+1)----|  
  |<-----FIN(w)------|  (FIN_WAIT_2 â†’ LAST_ACK)
  |--ACK(w+1)--------|  (TIME_WAIT â†’ CLOSED)
```

é€šè¿‡ä»¥ä¸Šå¤šå±‚æ¬¡åˆ†æžï¼Œå¯å…¨é¢ç†è§£TCPè¿žæŽ¥ç®¡ç†çš„æ ¸å¿ƒæœºåˆ¶åŠå…¶å·¥ç¨‹å®žè·µä¸­çš„å…³é”®è€ƒé‡ã€‚
