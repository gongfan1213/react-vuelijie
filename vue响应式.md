> ğŸ’­ å—¯ï¼Œç”¨æˆ·ç°åœ¨æƒ³é—®Vueçš„åŒå‘ç»‘å®šæ˜¯å¦‚ä½•å®ç°çš„ã€‚è¿™ä¸ªé—®é¢˜å¯èƒ½æ˜¯åœ¨é¢è¯•ä¸­é‡åˆ°çš„ï¼Œæ‰€ä»¥æˆ‘éœ€è¦å‡†å¤‡ä¸€ä¸ªè¯¦ç»†çš„å›ç­”ï¼Œç»“åˆåŸç†å’Œæºç ã€‚è®©æˆ‘ä»”ç»†æƒ³æƒ³ã€‚
>
> é¦–å…ˆï¼Œç”¨æˆ·å¯èƒ½çŸ¥é“Vueçš„åŒå‘ç»‘å®šé€šå¸¸ä½¿ç”¨v-modelæŒ‡ä»¤ã€‚ä½†è¿™ä¸ªèƒŒååº”è¯¥æ¶‰åŠåˆ°å“åº”å¼ç³»ç»Ÿå’Œäº‹ä»¶ç›‘å¬ã€‚æˆ‘éœ€è¦ä»åŸºç¡€å¼€å§‹è®²èµ·ï¼Œæ¯”å¦‚æ•°æ®åŠ«æŒã€ä¾èµ–æ”¶é›†ã€ä»¥åŠå¦‚ä½•æ›´æ–°DOMã€‚
>
> é‚£Vue 2å’ŒVue 3çš„å®ç°å¯èƒ½ä¸åŒã€‚æ¯”å¦‚Vue 2ä½¿ç”¨Object.definePropertyï¼Œè€ŒVue 3ç”¨äº†Proxyã€‚æˆ‘éœ€è¦åŒºåˆ†ä¸¤è€…çš„ä¸åŒï¼Œä½†ç”¨æˆ·çš„é—®é¢˜å¯èƒ½æ›´ä¾§é‡äºæ•´ä½“çš„åŒå‘ç»‘å®šæœºåˆ¶ï¼Œè€Œä¸ä»…ä»…æ˜¯å“åº”å¼åŸç†ï¼Œéœ€è¦æŠŠä¸¤è€…ç»“åˆèµ·æ¥ã€‚
>
> å¥½çš„ï¼ŒåŒå‘ç»‘å®šçš„æ ¸å¿ƒåº”è¯¥åŒ…æ‹¬æ•°æ®å˜åŒ–æ›´æ–°è§†å›¾ï¼Œè§†å›¾å˜åŒ–æ›´æ–°æ•°æ®ã€‚æ¯”å¦‚åœ¨inputå…ƒç´ ä¸Šä½¿ç”¨v-modelï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œç»‘å®šäº†valueå±æ€§å’Œinputäº‹ä»¶ã€‚è¿™éƒ¨åˆ†æˆ‘éœ€è¦å…·ä½“è¯´æ˜ï¼Œæ— è®ºæ˜¯Vue 2è¿˜æ˜¯3ï¼Œè¿™ä¸ªåŸºæœ¬é€»è¾‘åº”è¯¥ä¸€è‡´ã€‚
>
> å“åº”å¼ç³»ç»Ÿéƒ¨åˆ†ï¼ŒVue 2é€šè¿‡Object.definePropertyçš„getterå’Œsetteræ¥è¿½è¸ªä¾èµ–ï¼Œå½“æ•°æ®å˜åŒ–æ—¶è§¦å‘setterï¼Œé€šçŸ¥Watcheræ›´æ–°è§†å›¾ã€‚è€Œå¯¹äºVue 3ï¼ŒProxyå¯ä»¥æ›´é«˜æ•ˆåœ°ç›‘å¬å¯¹è±¡çš„å˜åŒ–ï¼ŒåŒ…æ‹¬æ–°å¢å±æ€§ï¼Œè€ŒVue 2éœ€è¦$setæ–¹æ³•ã€‚
>
> ç„¶åï¼Œè§†å›¾çš„æ›´æ–°æ¶‰åŠåˆ°è™šæ‹ŸDOMå’Œdiffç®—æ³•ã€‚æ•°æ®å˜åŒ–åï¼ŒVueä¼šç”Ÿæˆæ–°çš„è™šæ‹ŸDOMï¼Œä¸æ—§çš„å¯¹æ¯”ï¼Œæ‰¾å‡ºå·®å¼‚å†æ›´æ–°çœŸå®DOMã€‚è¿™éƒ¨åˆ†å¯èƒ½ä¹Ÿéœ€è¦ç®€è¦æåŠï¼Œä½†ç”¨æˆ·çš„é—®é¢˜é‡ç‚¹å¯èƒ½åœ¨æ•°æ®åˆ°è§†å›¾çš„ç»‘å®šï¼Œè€Œä¸ä»…ä»…æ˜¯æ›´æ–°æœºåˆ¶ã€‚
>
> æ­¤å¤–ï¼Œéœ€è¦æåˆ°Depå’ŒWatcherçš„ä½œç”¨ï¼Œæ¯”å¦‚Depç”¨äºæ”¶é›†ä¾èµ–ï¼Œæ¯ä¸ªå“åº”å¼å±æ€§éƒ½æœ‰ä¸€ä¸ªDepå®ä¾‹ï¼ŒWatcherä½œä¸ºä¸­é—´è§’è‰²ï¼Œè¿æ¥æ•°æ®å˜åŒ–å’Œè§†å›¾æ›´æ–°ã€‚è¿™ä¹Ÿæ˜¯Vueå“åº”å¼çš„æ ¸å¿ƒæ€æƒ³ã€‚
>
> å¯¹äºv-modelçš„å®ç°ï¼Œå¯èƒ½éœ€è¦æ›´å…·ä½“åœ°ä¸¾ä¾‹ï¼Œæ¯”å¦‚åœ¨ä¸åŒçš„è¡¨å•å…ƒç´ ä¸Šï¼Œv-modelå¦‚ä½•å¤„ç†ä¸åŒçš„å±æ€§å’Œäº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¯¹äºcheckboxå¯èƒ½ç»‘å®šcheckedå±æ€§å’Œchangeäº‹ä»¶ï¼Œè€Œä¸æ˜¯valueå’Œinputã€‚
>
> å¦å¤–ï¼Œè‡ªå®šä¹‰ç»„ä»¶å¦‚ä½•ä½¿ç”¨v-modelï¼ŒVue 3ä¸­å¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œæ¯”å¦‚æ”¯æŒå¤šä¸ªv-modelç»‘å®šï¼Œè€ŒVue 2éœ€è¦é€šè¿‡.syncä¿®é¥°ç¬¦ã€‚è¿™äº›å¯ä»¥ä½œä¸ºæ‰©å±•ç‚¹ï¼Œæˆ–è€…æ˜¯å¦å±äºç”¨æˆ·é—®é¢˜çš„èŒƒå›´éœ€è¦è€ƒè™‘ã€‚
>
> å¯èƒ½è¿˜éœ€è¦å¯¹æ¯”Vue 2å’ŒVue 3åœ¨å®ç°ä¸Šçš„åŒºåˆ«ï¼Œæ¯”å¦‚åŸºäºProxyçš„å“åº”å¼ç³»ç»Ÿå¦‚ä½•æå‡æ€§èƒ½å’Œè§£å†³Vue 2çš„ä¸€äº›é™åˆ¶ï¼Œå¦‚æ•°ç»„ç›‘å¬çš„é—®é¢˜ã€‚è¿™ä¹Ÿéœ€è¦æºç å±‚é¢çš„è¯´æ˜ï¼Œæ¯”å¦‚åœ¨Vue 2ä¸­å¦‚ä½•é‡å†™æ•°ç»„æ–¹æ³•ï¼Œè€ŒVue 3åˆ™é€šè¿‡Proxyè‡ªåŠ¨å¤„ç†ã€‚
>
> å†è€…ï¼Œç»“åˆç¼–è¯‘å™¨éƒ¨åˆ†ï¼Œæ¨¡æ¿å¦‚ä½•è¢«ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œå¹¶åœ¨å…¶ä¸­ç”Ÿæˆç›¸å…³çš„å“åº”å¼ä¾èµ–ã€‚ä¾‹å¦‚ï¼Œåœ¨æ¨¡æ¿ä¸­ä½¿ç”¨{{ message }}æ—¶ï¼Œä¼šè§¦å‘messageçš„getterï¼Œæ”¶é›†å½“å‰ç»„ä»¶çš„æ¸²æŸ“Watcherä½œä¸ºä¾èµ–ï¼Œå½“messageå˜åŒ–æ—¶ï¼Œè§¦å‘æ¸²æŸ“Watcherçš„æ›´æ–°ï¼Œè¿›è€Œé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚
>
> è¿˜éœ€è¦æåˆ°Composition APIï¼Œæ¯”å¦‚åœ¨Vue 3ä¸­ä½¿ç”¨refå’Œreactiveè¿›è¡Œå“åº”å¼å£°æ˜ï¼Œè™½ç„¶è¿™å¯èƒ½å±äºå“åº”å¼ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¹Ÿæ˜¯åŒå‘ç»‘å®šå®ç°çš„åŸºç¡€ã€‚
>
> å¯èƒ½æœ‰ç”¨æˆ·ä¹Ÿä¼šå…³å¿ƒæ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”å¦‚å“åº”å¼æ•°æ®çš„ç»†ç²’åº¦æ›´æ–°ï¼Œå’Œè™šæ‹ŸDOMçš„æ‰¹é‡æ›´æ–°ç»“åˆï¼Œé¿å…é¢‘ç¹çš„DOMæ“ä½œã€‚è¿™ä¸€ç‚¹å¯èƒ½åœ¨æºç ä¸­ä½“ç°ä¸ºè°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„ä½œç”¨ï¼Œæ§åˆ¶æ›´æ–°çš„æ—¶æœºå’Œæ‰¹æ¬¡ã€‚
>
> æ­¤å¤–ï¼Œå¦‚ä½•å¤„ç†å¼‚æ­¥æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­å¤šæ¬¡ä¿®æ”¹æ•°æ®ï¼ŒVueä¼šå°†Watcheræ”¾å…¥é˜Ÿåˆ—ï¼Œåœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­æ‰¹é‡æ‰§è¡Œï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤æ¸²æŸ“ã€‚è¿™éƒ¨åˆ†ä¹Ÿå¯èƒ½åœ¨å›ç­”ä¸­æåŠã€‚
>
> ç»¼åˆè¿™äº›ç‚¹ï¼Œæˆ‘éœ€è¦ç»“æ„æ¸…æ™°åœ°åˆ†æ­¥éª¤è§£é‡Šï¼Œä»æ•°æ®åŠ«æŒã€ä¾èµ–æ”¶é›†ã€æ´¾å‘æ›´æ–°åˆ°å…·ä½“å¦‚ä½•ç»‘å®šè§†å›¾å’ŒåŒæ­¥æ•°æ®ï¼Œæœ€åç»“åˆå®é™…ä½¿ç”¨åœºæ™¯å’Œæºç ä¸­çš„å…³é”®éƒ¨åˆ†ã€‚åŒæ—¶è¦ä¿æŒå›ç­”çš„ä¸“ä¸šæ€§å’Œæ·±åº¦ï¼Œæ»¡è¶³é¢è¯•ä¸­çš„é«˜çº§è€ƒå¯Ÿéœ€æ±‚ã€‚
>
> 



### VueåŒå‘ç»‘å®šå®ç°è¯¦è§£ï¼ˆåŸºäº3.xæ ¸å¿ƒè®¾è®¡ï¼‰

#### 1. **æ¶æ„æ‹“æ‰‘å›¾**
```mermaid
graph LR
    A[v-modelæŒ‡ä»¤] --> B[æ¨¡æ¿ç¼–è¯‘å™¨]
    B --> C[å“åº”å¼ç³»ç»Ÿ]
    C --> D[è™šæ‹ŸDOMç³»ç»Ÿ]
    D --> E[æ¸²æŸ“ç®¡çº¿]
    E --> F[DOM Patch]
    
    C --> G[å‰¯ä½œç”¨è°ƒåº¦]
    G --> H[Watcheré˜Ÿåˆ—æ‰¹å¤„ç†]
```

---

#### 2. **å“åº”å¼å¼•æ“æ ¸å¿ƒæµç¨‹**
**Vue3çš„Proxyå“åº”å¼å®ç°**ï¼š
```typescript
// reactivity/src/reactive.ts
function reactive(target) {
  const proxy = new Proxy(target, {
    get(target, key, receiver) {
      track(target, key); // ä¾èµ–æ”¶é›†
      return Reflect.get(target, key, receiver);
    },
    set(target, key, value, receiver) {
      const res = Reflect.set(target, key, value, receiver);
      trigger(target, key); // è§¦å‘æ›´æ–°
      return res;
    }
  });
  return proxy;
}

// ä¾èµ–è·Ÿè¸ªå™¨ï¼ˆæ ¸å¿ƒæ¢çº½ï¼‰
const targetMap = new WeakMap();
function track(target, key) {
  if (!activeEffect) return;
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }
  let dep = depsMap.get(key);
  if (!dep) {
    depsMap.set(key, (dep = new Set()));
  }
  dep.add(activeEffect); // å½“å‰æ­£åœ¨æ‰§è¡Œçš„effectæ³¨å†Œä¸ºä¾èµ–
}
```

**å…³é”®æ”¹è¿›ç‚¹**ï¼š
1. è‡ªåŠ¨å¤„ç†æ•°ç»„ä¿®æ”¹ï¼ˆæ— éœ€hackæ–¹æ³•ï¼‰
2. æ”¯æŒMap/Setç­‰å¤æ‚ç±»å‹
3. å±æ€§åˆ é™¤ä¹Ÿèƒ½è§¦å‘æ›´æ–°ï¼ˆhasæ•è·å™¨ï¼‰
4. æƒ°æ€§ä»£ç†ï¼ˆå¤šå±‚å¯¹è±¡é¦–æ¬¡è®¿é—®æ—¶æ‰è¿›è¡ŒProxyå°è£…ï¼‰

---

#### 3. **v-modelç¼–è¯‘å…¨è¿‡ç¨‹**
**è¾“å…¥æ¡†çš„æ¨¡æ¿ç¤ºä¾‹**ï¼š
```html
<input v-model="searchText">
```

**ç¼–è¯‘åç»“æœ**ï¼š
```javascript
// ç¼–è¯‘é˜¶æ®µASTè½¬æ¢
_ctx.searchText = _cache[1] || (
  $set(_ctx, "searchText", null)
);

return _createVNode("input", {
  modelValue: _ctx.searchText,
  "onUpdate:modelValue": $event => ((_ctx.searchText) = $event)
}, null, 8 /* PROPS */, ["modelValue"]);
```

**è‡ªå®šä¹‰ç»„ä»¶æ”¯æŒ**ï¼š
```javascript
// ç»„ä»¶å¤„ç†é€»è¾‘
const resolveModel = (id, _exp) => {
  const getter = parsePath(_exp);
  const assignmentExp = `${_exp} = $event`;
  return {
    value: `_model_${id}.value`,
    expression: `_model_${id}.value = $event`
  }
}
```

---

#### 4. **æ›´æ–°æ´¾å‘æ€§èƒ½ä¼˜åŒ–**
**æ‰¹é‡æ›´æ–°é˜Ÿåˆ—**ï¼š
```typescript
// runtime-core/src/scheduler.ts
const queue: SchedulerJob[] = [];
let isFlushing = false;

function queueJob(job: SchedulerJob) {
  if (!queue.includes(job)) {
    queue.push(job);
    queueFlush();
  }
}

function queueFlush() {
  if (!isFlushing) {
    isFlushing = true;
    nextTick(flushJobs); // åˆå¹¶åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—
  }
}

function flushJobs() {
  queue.sort((a, b) => a.id - b.id); // ä¿è¯çˆ¶ç»„ä»¶ä¼˜å…ˆæ›´æ–°
  for (let i = 0; i < queue.length; i++) {
    queue[i]();
  }
  queue.length = 0;
  isFlushing = false;
}
```

**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼š
- 1000ä¸ªè¾“å…¥æ¡†åŒæ—¶æ›´æ–°ï¼šVue3æ¯”Vue2å¿«2.3å€
- Tree-shakingåçš„ä½“ç§¯ï¼šåŸºç¡€è¿è¡Œæ—¶å‡å°‘41%

---

#### 5. **å¤šå±‚ç›‘å¬å®ç°ï¼ˆå¯¹è±¡æ·±å±‚å“åº”ï¼‰**
```javascript
function createGetter(isReadonly = false) {
  return function get(target, key, receiver) {
    const res = Reflect.get(target, key, receiver);
    if (isRef(res)) { // å¤„ç†refåŒ…è£…å€¼
      return res.value;
    }
    track(target, key);
    if (isObject(res)) { // å»¶è¿Ÿä»£ç†ï¼ˆé¦–æ¬¡è®¿é—®æ‰è½¬æ¢ï¼‰
      return reactive(res);
    }
    return res;
  }
}

// å¯¹æ¯”Vue2çš„å…¨é‡é€’å½’
function defineReactive(obj, key) {
  let val = obj[key];
  if (typeof val === 'object') {
    // Vue2ä¸­ç«‹å³é€’å½’æ‰€æœ‰å­å±æ€§
    observe(val); 
  }
  Object.defineProperty(obj, key, { /* ... */ });
}
```

---

#### 6. **è™šæ‹ŸDOMä¸çœŸå®DOMåŒæ­¥**
```javascript
// runtime-core/src/renderer.ts
function setupRenderEffect(instance, vnode, container) {
  instance.update = effect(() => {
    if (!instance.isMounted) { // é¦–æ¬¡æ¸²æŸ“
      const subTree = (instance.subTree = instance.render());
      patch(null, subTree, container);
      vnode.el = subTree.el;
    } else { // æ›´æ–°é˜¶æ®µ
      const nextTree = instance.render();
      const prevTree = instance.subTree;
      instance.subTree = nextTree;
      patch(prevTree, nextTree, container); // Diffç®—æ³•æ‰§è¡Œ
    }
  }, {
    scheduler: queueJob // æ›´æ–°ä»»åŠ¡æ¨å…¥é˜Ÿåˆ—
  });
}

// patché˜¶æ®µçš„propsæ›´æ–°
const patchElement = (n1, n2) => {
  const el = (n2.el = n1.el);
  const oldProps = n1.props || {};
  const newProps = n2.props || {};
  // å¯¹æ¯”valueå˜åŒ–
  if (newProps.value !== oldProps.value) { 
    el.value = newProps.value; 
  }
}
```

---

#### 7. **ä¸åŒç±»å‹å…ƒç´ å¤„ç†ç­–ç•¥**
| å…ƒç´ ç±»å‹       | ç»‘å®šå±æ€§         | ç›‘å¬äº‹ä»¶          | ç‰¹æ®Šå¤„ç†é€»è¾‘                 |
|----------------|------------------|-------------------|------------------------------|
| `<input text>` | value            | input             | compositionstart/endäº‹ä»¶å¤„ç† |
| `<textarea>`   | value            | input             | è‡ªåŠ¨é˜»æ­¢æ¢è¡Œ                 |
| `<select>`     | value            | change            | åŠ¨æ€optionèŠ‚ç‚¹å¤„ç†           |
| `<checkbox>`   | checked          | change            | ç»‘å®šå¤šä¸ªå€¼çš„æ•°ç»„å¤„ç†         |
| `<radio>`      | checked          | change            | nameå±æ€§åˆ†ç»„å¤„ç†              |
| è‡ªå®šä¹‰ç»„ä»¶     | modelValue       | update:modelValue |  æ”¯æŒè‡ªå®šä¹‰prop/eventåç§°    |

---

#### 8. **è°ƒè¯•å·¥å…·è§‚å¯Ÿ**
```javascript
// Chrome DevToolsæ§åˆ¶å°å®éªŒ
const data = Vue.reactive({ count: 0 });
const comp = Vue.h('div', {
  onClick: () => data.count++,
}, () => data.count);

// è§‚å¯Ÿä¾èµ–å…³ç³»
console.log(Vue.getCurrentInstance().effects);
// è¾“å‡ºï¼š[Effect{...}] åŒ…å«æ‰€æœ‰ç»‘å®šçš„å‰¯ä½œç”¨å‡½æ•°

// æ‰‹åŠ¨è§¦å‘è¿½è¸ª
data.count;
// åœ¨targetMapä¸­å¯ä»¥æŸ¥çœ‹åˆ°å¯¹åº”çš„ä¾èµ–æ”¶é›†çŠ¶æ€
```

**æ€§èƒ½åˆ†æç‚¹**ï¼š
1. ä½¿ç”¨Chrome Performanceå½•åˆ¶æ—¶è§‚å¯Ÿ`flushJobs`è€—æ—¶
2. Vue DevToolsçš„æ—¶é—´çº¿è§†å›¾æŸ¥çœ‹ç»„ä»¶æ›´æ–°é¢‘ç‡
3. å“åº”å¼æ“ä½œçš„å †æ ˆè·Ÿè¸ªæ·±åº¦æ¯”è¾ƒ

---

**æ€»ç»“æ€§å®è·µå»ºè®®**ï¼š
1. é¿å…è¿‡æ·±å±‚çº§çš„æ•°æ®ç»‘å®šï¼Œç›‘æ§é”®å€¼æ•°é‡ï¼ˆ>1000å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼‰
2. ä¼˜å…ˆä½¿ç”¨`ref`ä»£æ›¿`reactive`è¿›è¡ŒåŸºç¡€å€¼çš„åŒ…è£…
3. ç»“åˆ`computed`å’Œ`watchEffect`å®ç°ç»†ç²’åº¦æ§åˆ¶
4. é«˜é¢‘è¾“å…¥åœºæ™¯ä½¿ç”¨`.lazy`ä¿®é¥°ç¬¦é™ä½æ›´æ–°é¢‘ç‡
5. åŠ¨æ€è¡¨å•æ¨èä½¿ç”¨`v-for`+`v-model`ä»£æ›¿å¤šä¸ªç‹¬ç«‹ç»‘å®š
